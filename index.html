<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚·ãƒ§ã‚¦ãƒ¯ãƒ¬ãƒˆãƒ­ãƒƒãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Fonts & Variables --- */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Shippori+Mincho:wght@400;700&display=swap');
        :root {
            --paper-bg: #f4e4bc;
            --ink-black: #2c2c2c;
            --ink-red: #8b0000;
            --card-w: 140px; --card-h: 240px; 
        }
        @media (min-width: 375px) { :root { --card-w: 160px; --card-h: 274px; } }
        @media (orientation: landscape) and (max-height: 600px) {
            :root { --card-w: 70px; --card-h: 120px; }
            #title-img { display: none !important; }
            header { padding: 0.25rem !important; min-height: 2rem; }
            #table-top { padding-top: 1rem; }
            #deck-area { bottom: 0.5rem !important; transform: translateX(-50%) scale(0.8) !important; }
        }

        /* --- Global --- */
        body {
            background-color: var(--paper-bg);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.1'/%3E%3C/svg%3E");
            color: var(--ink-black);
            font-family: 'Shippori Mincho', serif;
            overflow: hidden; height: 100vh; height: 100dvh;
            display: flex; flex-direction: column; touch-action: none;
        }
        .headline { font-family: 'Playfair Display', serif; }

        /* --- Cards --- */
        .card-scene {
            width: var(--card-w); height: var(--card-h);
            position: absolute; transform-style: preserve-3d; cursor: grab;
            opacity: 0; z-index: 10; touch-action: none;
            margin-left: calc(var(--card-w) * -0.5);
            margin-top: calc(var(--card-h) * -0.5);
        }
        .card-scene:active { cursor: grabbing; }
        
        .card-obj {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; border-radius: 6px;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 2px 4px 8px rgba(0,0,0,0.3); pointer-events: none;
        }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 6px;
            overflow: hidden; border: 1px solid #444; background: #fff;
        }
        .card-face.front { transform: rotateY(180deg); display: flex; justify-content: center; align-items: center; }
        .card-face.back {
            background: #2a2a2a;
            background-image: repeating-linear-gradient(45deg, #333 0, #333 1px, #444 0, #444 50%);
        }
        .card-face img { width: 100%; height: 100%; object-fit: cover; }
        .card-obj.is-open { transform: rotateY(180deg); }

        /* --- Layout --- */
        #table-top {
            position: relative; flex-grow: 1; width: 100%;
            overflow: hidden; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1;
        }
        #spread-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            max-width: 800px; left: 50%; transform: translateX(-50%);
            pointer-events: none; z-index: 20; 
        }
        #deck-area {
            position: absolute; bottom: 10%; left: 50%;
            transform: translateX(-50%); width: var(--card-w); height: var(--card-h);
            z-index: 30; transition: all 0.3s;
        }
        .deck-card {
            position: absolute; inset: 0; border-radius: 6px;
            border: 1px solid #333; background: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .shuffling .deck-card:nth-child(odd) { animation: shuffleShake 0.15s infinite alternate; }
        .shuffling .deck-card:nth-child(even) { animation: shuffleShake 0.15s infinite alternate-reverse; }
        @keyframes shuffleShake {
            0% { transform: translate(0,0) rotate(0); }
            25% { transform: translate(-10px, 0) rotate(-2deg); }
            50% { transform: translate(0,0) rotate(0); }
            75% { transform: translate(10px, 0) rotate(2deg); }
            100% { transform: translate(0,0) rotate(0); }
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(44, 44, 44, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: grayscale(100%) blur(2px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .paper-modal {
            background: var(--paper-bg); border: 4px double var(--ink-black);
            padding: 1.5rem; width: 90%; max-width: 400px; text-align: center;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.5); transform: scale(0.95);
            transition: transform 0.2s; max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.active .paper-modal { transform: scale(1); }
        
        .paper-btn {
            background: var(--ink-black); color: var(--paper-bg); border: none;
            padding: 10px 20px; font-family: 'Shippori Mincho', serif;
            font-weight: bold; letter-spacing: 1px; cursor: pointer;
            transition: all 0.2s; box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
        }
        .paper-btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 rgba(0,0,0,0.3); }
        .paper-btn.secondary { background: transparent; color: var(--ink-black); border: 2px solid var(--ink-black); }
        .paper-input {
            width: 100%; background: transparent; border: none;
            border-bottom: 2px solid var(--ink-black); padding: 10px;
            font-family: 'Shippori Mincho', serif; font-size: 1.1rem;
            color: var(--ink-black); outline: none; margin-bottom: 1rem; border-radius: 0;
        }

        #toast-container { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 90%; pointer-events: none; }
        .toast {
            background: var(--ink-black); color: var(--paper-bg); padding: 12px 20px;
            margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-family: 'Shippori Mincho', serif; display: flex; align-items: center; justify-content: center;
            animation: slideDown 0.3s ease-out; pointer-events: auto; border: 1px solid var(--paper-bg);
        }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- Guide --- */
        #guide-container { position: absolute; bottom: 0; right: 0; pointer-events: none; z-index: 40; display: flex; flex-direction: column; align-items: flex-end; padding: 10px; max-width: 60%; }
        .guide-bubble {
            background: #2c2c2c; color: #f4e4bc; padding: 12px; border-radius: 12px 12px 0 12px;
            margin-bottom: 8px; border: 2px solid #f4e4bc; font-size: 0.85rem; font-weight: bold;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3); opacity: 0; transform: scale(0.8); transition: all 0.3s;
        }
        .guide-bubble.show { opacity: 1; transform: scale(1); }
        .guide-img { width: 100px; height: 100px; object-fit: contain; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5)); }
    </style>
</head>
<body>

    <header class="w-full px-4 py-2 bg-[#f4e4bc]/95 flex flex-col items-center shadow-sm z-50 relative">
        <div class="w-full flex justify-between items-end border-b border-black/20 pb-1 mb-1 w-full">
             <span id="current-date" class="text-xs font-serif tracking-widest text-gray-700"></span>
             <button id="btn-login-header" class="text-xs underline font-bold cursor-pointer text-gray-800 hover:text-red-900">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
        <img id="title-img" src="images/title.png" alt="The Daily Oracle" class="h-12 md:h-16 object-contain">
        <div id="topic-display" class="hidden mt-1 text-center w-full border-t border-gray-400/50 pt-1">
            <span class="text-xs mr-2 text-gray-600">ãƒ†ãƒ¼ãƒ:</span>
            <span id="topic-text-content" class="font-bold text-red-900 text-sm"></span>
        </div>
    </header>

    <main id="table-top">
        <div id="toast-container"></div>
        <div id="spread-layer"></div>
        
        <div id="deck-area">
            <div id="deck-stack" class="relative w-full h-full cursor-pointer">
                <div class="deck-card" style="transform: translate(0,0)"></div>
                <div class="deck-card" style="transform: translate(3px,3px)"></div>
                <div class="deck-card" style="transform: translate(6px,6px)"><img id="deck-top-img" src="" class="w-full h-full object-cover rounded-md"></div>
            </div>
        </div>

        <div id="guide-container">
            <div id="guide-bubble" class="guide-bubble">ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
            <img id="guide-img" src="" class="guide-img">
        </div>
    </main>

    <footer class="w-full bg-[#f4e4bc] border-t-2 border-black p-2 z-50 h-auto min-h-[80px] flex items-center justify-center">
        <div class="flex flex-wrap justify-center items-center gap-2 w-full max-w-lg">
            <div class="relative w-40">
                <select id="spread-select" class="w-full bg-transparent border-2 border-black px-2 py-2 font-serif text-sm rounded-none appearance-none cursor-pointer focus:outline-none">
                    <option value="one_oracle">ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ« (1æš)</option>
                    <option value="two_oracle">ğŸ”’ ãƒ„ãƒ¼ã‚ªãƒ©ã‚¯ãƒ« (2æš)</option>
                    <option value="two_mind">ğŸ”’ ãƒ„ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ (2æš)</option>
                    <option value="simple_cross">ğŸ”’ ã‚·ãƒ³ãƒ—ãƒ«ã‚¯ãƒ­ã‚¹ (2æš)</option>
                    <option value="three_card">ğŸ”’ ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ (3æš)</option>
                    <option value="four_card">ğŸ”’ ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰ (4æš)</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-xs"><i class="fa-solid fa-caret-down"></i></div>
            </div>
            <button id="btn-shuffle" class="paper-btn">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
            <button id="btn-open" class="paper-btn secondary hidden" disabled>é–‹ã</button>
            <button id="btn-reset" class="paper-btn secondary hidden">ã‚‚ã†ä¸€åº¦</button>
            <button id="btn-share" class="paper-btn bg-white text-black border-2 border-black hidden"><i class="fa-solid fa-share-nodes"></i></button>
        </div>
    </footer>

    <div id="login-modal" class="modal-overlay">
        <div class="paper-modal">
            <h2 class="headline text-2xl mb-4 border-b-2 border-black pb-2">ä¼šå“¡ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <p class="text-sm mb-6 text-gray-700">
                ã“ã¡ã‚‰ã¯ Save Point ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è€…å‘ã‘ã§ã™ã€‚<br>
            </p>
            <form id="form-login">
                <input type="text" id="login-id" class="paper-input" placeholder="ID (ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹)" autocomplete="username" required>
                <input type="password" id="login-pass" class="paper-input" placeholder="Password" autocomplete="current-password" required>
                <div id="login-error" class="text-red-700 text-sm mb-4 hidden">IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div>
                
                <div class="flex flex-col gap-3 mt-4">
                    <button type="submit" id="btn-submit-login" class="paper-btn w-full">èªè¨¼ã™ã‚‹</button>
                    <div class="flex justify-between items-center text-xs mt-2">
                        <button type="button" id="link-forgot-pass" class="underline text-blue-800 hover:text-blue-600">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸ</button>
                        <a href="https://savepoint.design4qol.com" target="_blank" class="underline text-blue-800 hover:text-blue-600">æ–°è¦ç™»éŒ²ã™ã‚‹</a>
                    </div>
                    <button type="button" id="btn-close-login" class="underline text-sm text-gray-600 mt-2">é–‰ã˜ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reset-modal" class="modal-overlay">
        <div class="paper-modal">
            <h2 class="headline text-2xl mb-4 border-b-2 border-black pb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š</h2>
            <p class="text-sm mb-6 text-gray-700">
                ç™»éŒ²ã—ã¦ã„ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
                å†è¨­å®šç”¨ã®ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã™ã€‚
            </p>
            <form id="form-reset">
                <input type="email" id="reset-email" class="paper-input" placeholder="Email Address" required>
                <div id="reset-msg" class="text-sm mb-4 hidden"></div>
                <div class="flex flex-col gap-3 mt-4">
                    <button type="submit" class="paper-btn w-full">é€ä¿¡</button>
                    <button type="button" id="btn-close-reset" class="underline text-sm text-gray-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <div id="topic-modal" class="modal-overlay">
        <div class="paper-modal">
            <h2 class="headline text-2xl mb-4 border-b-2 border-black pb-2">å ã„ã®ãƒ†ãƒ¼ãƒ</h2>
            <p class="text-sm mb-6 text-gray-700 text-left">ä»Šæ—¥ã‚ãªãŸã¯ä½•ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿ</p>
            <input type="text" id="topic-input" class="paper-input" placeholder="ä¾‹: ä»Šå¾Œã®ã‚­ãƒ£ãƒªã‚¢ã«ã¤ã„ã¦...">
            <div class="flex flex-col gap-3 mt-4">
                <button id="btn-submit-topic" class="paper-btn w-full">å ã„ã‚’å§‹ã‚ã‚‹</button>
                <button id="btn-cancel-topic" class="underline text-sm text-gray-600">ã‚¹ã‚­ãƒƒãƒ— (ãƒ†ãƒ¼ãƒãªã—)</button>
            </div>
        </div>
    </div>

    <script>
        // â–¼ GAS URL (ãƒ‡ãƒ—ãƒ­ã‚¤URL)
        const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzFidZHGCpxVsoJ9tMzjg3oFpZwiPEkyiZR7Pv5O242lRieemSF7vAEihsJbv29NF7t/exec"; 

        const IMG_PATH = 'images/';
        const BACK_IMG = 'back.jpg';
        const SEER_IMG = 'seer.png';

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰å®šç¾©
        const SPREADS = {
            'one_oracle':   { count: 1, pos: [{x:50, y:45}], login: false },
            'two_oracle':   { count: 2, pos: [{x:35, y:45}, {x:65, y:45}], login: true },
            'two_mind':     { count: 2, pos: [{x:50, y:30}, {x:50, y:65}], login: true },
            'simple_cross': { count: 2, pos: [{x:50, y:45}, {x:50, y:45, rot:90}], login: true },
            'three_card':   { count: 3, pos: [{x:20, y:45}, {x:50, y:45}, {x:80, y:45}], login: true },
            'four_card':    { count: 4, pos: [{x:30, y:30}, {x:70, y:30}, {x:30, y:65}, {x:70, y:65}], login: true }
        };

        // State
        let state = { deck:[], drawn:[], phase:'IDLE', user:null, topic:'' };
        let currentSpread = 'one_oracle';

        // Elements
        const ui = {
            spread: document.getElementById('spread-layer'),
            deck: document.getElementById('deck-area'),
            deckStack: document.getElementById('deck-stack'),
            guideTxt: document.getElementById('guide-bubble'),
            guideImg: document.getElementById('guide-img'),
            select: document.getElementById('spread-select'),
            btnLoginHead: document.getElementById('btn-login-header'),
            modalLogin: document.getElementById('login-modal'),
            modalReset: document.getElementById('reset-modal'),
            modalTopic: document.getElementById('topic-modal'),
            btnShuffle: document.getElementById('btn-shuffle'),
            btnOpen: document.getElementById('btn-open'),
            btnReset: document.getElementById('btn-reset'),
            btnShare: document.getElementById('btn-share'),
            formLogin: document.getElementById('form-login'),
            formReset: document.getElementById('form-reset')
        };

        function init() {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('ja-JP') + " ç™ºè¡Œ";
            ui.guideImg.src = IMG_PATH + SEER_IMG;
            document.getElementById('deck-top-img').src = IMG_PATH + BACK_IMG;
            
            populateDeck(); 
            restoreSession(); 

            // --- Event Listeners ---

            // Login Logic (Fix: Use 'submit' event for better auto-fill support)
            ui.btnLoginHead.addEventListener('click', () => state.user ? logout() : show(ui.modalLogin));
            document.getElementById('btn-close-login').addEventListener('click', () => hide(ui.modalLogin));
            
            ui.formLogin.addEventListener('submit', (e) => {
                e.preventDefault(); // Stop reload
                tryLogin();
            });
            
            // Password Reset Logic
            document.getElementById('link-forgot-pass').addEventListener('click', () => {
                hide(ui.modalLogin); show(ui.modalReset);
            });
            document.getElementById('btn-close-reset').addEventListener('click', () => {
                hide(ui.modalReset); show(ui.modalLogin);
            });
            
            ui.formReset.addEventListener('submit', (e) => {
                e.preventDefault();
                tryReset();
            });

            // Spread Select
            ui.select.addEventListener('change', (e) => {
                if(SPREADS[e.target.value].login && !state.user) {
                    show(ui.modalLogin);
                    ui.select.value = currentSpread;
                } else {
                    currentSpread = e.target.value;
                    resetGame();
                }
            });

            // Game Buttons
            ui.btnShuffle.addEventListener('click', startShuffle);
            ui.deckStack.addEventListener('click', pickCard);
            ui.btnOpen.addEventListener('click', openCards);
            ui.btnReset.addEventListener('click', () => resetGame(true));
            ui.btnShare.addEventListener('click', shareResult);

            // Topic Modal
            document.getElementById('btn-submit-topic').addEventListener('click', () => {
                state.topic = document.getElementById('topic-input').value;
                hide(ui.modalTopic); updateTopicUI(); guide("ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãã ã•ã„ã€‚");
            });
            document.getElementById('btn-cancel-topic').addEventListener('click', () => {
                state.topic = "ãƒ†ãƒ¼ãƒãªã—";
                hide(ui.modalTopic); updateTopicUI(); guide("ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãã ã•ã„ã€‚");
            });

            // Drag
            document.addEventListener('mousedown', dragStart);
            document.addEventListener('touchstart', dragStart, {passive: false});
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('touchmove', dragMove, {passive: false});
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchend', dragEnd);
            
            window.addEventListener('resize', () => { if(state.phase === 'FINISHED') repositionCards(); });

            guide("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼ˆä¸¦ã¹æ–¹ï¼‰ã‚’é¸ã‚“ã§é–‹å§‹ã—ã¦ãã ã•ã„ã€‚");
        }

        function populateDeck() {
            state.deck = Array.from({length:22}, (_,i)=>i);
        }

        // --- Auth ---
        function restoreSession() {
            const saved = localStorage.getItem('tarot_user');
            if(saved) {
                state.user = JSON.parse(saved);
                updateAuthUI();
                showToast("ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: " + state.user.name, "success");
            }
        }

        async function tryLogin() {
            const id = document.getElementById('login-id').value;
            const pass = document.getElementById('login-pass').value;
            
            // NOTE: 'required' attribute on inputs handles empty check, but double check here
            if(!id || !pass) return;

            const btn = document.getElementById('btn-submit-login');
            const err = document.getElementById('login-error');
            
            btn.disabled = true; btn.innerText = "èªè¨¼ä¸­...";
            err.classList.add('hidden');

            try {
                const res = await fetch(API_ENDPOINT, {
                    method: 'POST', redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ type: 'auth', id: id, password: pass })
                });
                const data = await res.json();
                
                if(data.status === 'success') {
                    state.user = { name: data.username, email: id };
                    localStorage.setItem('tarot_user', JSON.stringify(state.user));
                    hide(ui.modalLogin);
                    updateAuthUI();
                    showToast("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ", "success");
                    resetGame(); // Refresh state
                } else {
                    err.innerText = data.message || "èªè¨¼å¤±æ•—";
                    err.classList.remove('hidden');
                }
            } catch(e) {
                err.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
                err.classList.remove('hidden');
            } finally {
                btn.disabled = false; btn.innerText = "èªè¨¼ã™ã‚‹";
            }
        }

        async function tryReset() {
            const email = document.getElementById('reset-email').value;
            const msg = document.getElementById('reset-msg');
            if(!email) return;

            msg.className = "text-sm mb-4 text-gray-600";
            msg.innerText = "é€ä¿¡ä¸­...";
            msg.classList.remove('hidden');

            try {
                const res = await fetch(API_ENDPOINT, {
                    method: 'POST', redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ type: 'reset', email: email })
                });
                const data = await res.json();
                msg.innerText = data.status === 'success' ? "å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ" : "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                if(data.status !== 'success') msg.className = "text-sm mb-4 text-red-600";
            } catch(e) {
                msg.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
                msg.className = "text-sm mb-4 text-red-600";
            }
        }

        function logout() {
            if(!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
            state.user = null;
            localStorage.removeItem('tarot_user');
            updateAuthUI();
            currentSpread = 'one_oracle'; ui.select.value = 'one_oracle';
            resetGame(true);
        }

        function updateAuthUI() {
            ui.btnLoginHead.innerText = state.user ? "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" : "ãƒ­ã‚°ã‚¤ãƒ³";
            Array.from(ui.select.options).forEach(opt => {
                if(state.user) opt.text = opt.text.replace("ğŸ”’ ", "");
                else if(SPREADS[opt.value].login && !opt.text.includes("ğŸ”’")) opt.text = "ğŸ”’ " + opt.text;
            });
        }

        // --- Game Logic (Fixed Reset) ---
        function resetGame(full = false) {
            state.phase = 'IDLE'; 
            state.drawn = [];
            populateDeck(); // â˜…CRITICAL FIX: å±±æœ­ã‚’å¾©æ´»ã•ã›ã‚‹

            ui.spread.innerHTML = '';
            ui.deck.classList.remove('hidden');
            ui.deckStack.classList.remove('shuffling');
            
            toggleBtns('init');
            ui.select.disabled = false;
            
            if(full) {
                state.topic = ''; updateTopicUI();
                guide("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼ˆä¸¦ã¹æ–¹ï¼‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
            } else {
                guide("æº–å‚™ãŒã§ããŸã‚‰ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãã ã•ã„ã€‚");
            }
        }

        function startShuffle() {
            if(state.phase !== 'IDLE' && state.phase !== 'FINISHED') return;
            if(state.user && !state.topic) {
                document.getElementById('topic-input').value = "";
                show(ui.modalTopic);
                return;
            }
            
            state.phase = 'SHUFFLING';
            ui.deckStack.classList.add('shuffling');
            populateDeck();
            ui.spread.innerHTML = ''; state.drawn = [];
            
            toggleBtns('shuffling');
            ui.select.disabled = true;
            guide("å±±æœ­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ã¦ãã ã•ã„ã€‚");
        }

        function pickCard() {
            if(state.phase !== 'SHUFFLING' && state.phase !== 'PICKING') return;
            const conf = SPREADS[currentSpread];
            
            // å±±æœ­ãƒã‚§ãƒƒã‚¯
            if(state.deck.length === 0) populateDeck();

            if(state.drawn.length >= conf.count) return;

            state.phase = 'PICKING';
            ui.deckStack.classList.remove('shuffling');

            // Draw
            const rIdx = Math.floor(Math.random() * state.deck.length);
            const cid = state.deck.splice(rIdx, 1)[0];
            const isRev = Math.random() < 0.5;

            // Create
            const el = document.createElement('div');
            el.className = 'card-scene';
            el.innerHTML = `
                <div class="card-obj">
                    <div class="card-face front"><img src="${IMG_PATH}${cid}.jpg" style="transform:${isRev?'rotate(180deg)':''}"></div>
                    <div class="card-face back"><img src="${IMG_PATH}${BACK_IMG}"></div>
                </div>`;
            ui.spread.appendChild(el);

            // Anim Start
            const sRect = ui.spread.getBoundingClientRect();
            el.style.left = (sRect.width / 2) + 'px';
            el.style.top = (sRect.height - 100) + 'px';
            el.style.opacity = 1;

            const pos = conf.pos[state.drawn.length];
            state.drawn.push({ id:cid, rev:isRev, el:el, pos:pos });

            // Anim End
            requestAnimationFrame(() => {
                el.style.transition = "all 0.5s ease-out";
                el.style.left = pos.x + '%'; 
                el.style.top = pos.y + '%';
                if(pos.rot) el.style.transform = `rotate(${pos.rot}deg)`;
            });

            if(state.drawn.length >= conf.count) {
                state.phase = 'READY';
                ui.deck.classList.add('hidden');
                toggleBtns('ready');
                guide("æƒã„ã¾ã—ãŸã€‚ã€Œé–‹ãã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            } else {
                setTimeout(() => { 
                    if(state.phase === 'PICKING') ui.deckStack.classList.add('shuffling'); 
                }, 400);
            }
        }

        function openCards() {
            if(state.phase !== 'READY') return;
            state.phase = 'OPENING';
            toggleBtns('opening');
            guide("é‹å‘½ã‚’ç´è§£ã„ã¦ã„ã¾ã™...");

            let delay = 0;
            state.drawn.forEach(c => {
                setTimeout(() => c.el.querySelector('.card-obj').classList.add('is-open'), delay);
                delay += 800;
            });

            setTimeout(() => {
                state.phase = 'FINISHED';
                toggleBtns('finished');
                guide("å®Œäº†ã€‚ã‚«ãƒ¼ãƒ‰ã¯è‡ªç”±ã«å‹•ã‹ã›ã¾ã™ã€‚");
                if(state.user) saveResult();
            }, delay + 600);
        }

        function saveResult() {
            if(!state.user) return;
            const payload = {
                type: 'save',
                date: new Date().toISOString(),
                username: state.user.name,
                email: state.user.email,
                theme: state.topic,
                spread: currentSpread,
                cards: state.drawn.map(c => ({ id: c.id, reversed: c.rev }))
            };
            fetch(API_ENDPOINT, {
                method: 'POST', redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
        }

        // --- Helpers ---
        function repositionCards() {
            state.drawn.forEach(item => {
                item.el.style.transition = "none";
                item.el.style.left = item.pos.x + '%';
                item.el.style.top = item.pos.y + '%';
            });
        }
        function updateTopicUI() {
            const el = document.getElementById('topic-display');
            const txt = document.getElementById('topic-text-content');
            if(state.topic) { el.classList.remove('hidden'); txt.innerText = state.topic; }
            else { el.classList.add('hidden'); }
        }
        function toggleBtns(phase) {
            ui.btnShuffle.classList.add('hidden'); ui.btnShuffle.disabled = true;
            ui.btnOpen.classList.add('hidden'); 
            ui.btnReset.classList.add('hidden'); 
            ui.btnShare.classList.add('hidden');
            
            if(phase === 'init') { ui.btnShuffle.classList.remove('hidden'); ui.btnShuffle.disabled = false; }
            if(phase === 'shuffling') { ui.btnShuffle.classList.remove('hidden'); }
            if(phase === 'ready') { ui.btnOpen.classList.remove('hidden'); ui.btnOpen.disabled = false; }
            if(phase === 'finished') { ui.btnReset.classList.remove('hidden'); ui.btnShare.classList.remove('hidden'); ui.btnShare.classList.add('flex'); }
        }
        function guide(msg) {
            ui.guideTxt.innerText = msg; ui.guideTxt.classList.add('show');
        }
        function show(el) { el.classList.add('active'); }
        function hide(el) { el.classList.remove('active'); }
        function showToast(m,t) {
            const d=document.createElement('div'); d.className='toast'; d.innerText=m;
            if(t==='success') d.style.borderLeft='4px solid #4caf50';
            document.getElementById('toast-container').appendChild(d);
            setTimeout(()=>d.remove(),3000);
        }
        async function shareResult() {
            const txt = `ğŸ”® The Daily Oracle\nResult: ${currentSpread}\nTheme: ${state.topic||'none'}`;
            try { await navigator.share({title:'Oracle', text:txt, url:'https://tarot.design4qol.com/'}); }
            catch(e) { navigator.clipboard.writeText(txt); showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
        }

        // Drag (Simple)
        let drag = null, dx=0, dy=0;
        function dragStart(e) {
            if(state.phase !== 'FINISHED') return;
            const t = e.target.closest('.card-scene');
            if(!t) return;
            const evt = e.touches ? e.touches[0] : e;
            drag = t; drag.style.zIndex = 100; drag.style.transition = 'none';
            const rect = drag.getBoundingClientRect();
            dx = evt.clientX - rect.left; dy = evt.clientY - rect.top;
            if(e.type==='touchstart') e.preventDefault();
        }
        function dragMove(e) {
            if(!drag) return;
            const evt = e.touches ? e.touches[0] : e;
            const parent = ui.spread.getBoundingClientRect();
            let x = evt.clientX - parent.left - dx + (drag.offsetWidth/2);
            let y = evt.clientY - parent.top - dy + (drag.offsetHeight/2);
            drag.style.left = x + 'px'; drag.style.top = y + 'px';
            if(e.cancelable) e.preventDefault();
        }
        function dragEnd() { if(drag) { drag.style.zIndex = 10; drag = null; } }

        init();
    </script>
</body>
</html>
