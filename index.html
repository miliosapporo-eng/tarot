<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚·ãƒ§ã‚¦ãƒ¯ãƒ¬ãƒˆãƒ­ãƒƒãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Retro Newspaper Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Shippori+Mincho:wght@400;700&display=swap');

        :root {
            --paper-bg: #f4e4bc;
            --ink-black: #2c2c2c;
            --ink-red: #8b0000;
            /* ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚º */
            --card-w: 160px;
            --card-h: 274px;
        }

        /* Mobile Optimization */
        @media (min-width: 375px) {
            :root {
                --card-w: 180px;
                --card-h: 308px;
            }
        }

        /* Landscape Optimization */
        @media (orientation: landscape) and (max-height: 600px) {
            :root {
                --card-w: 80px; 
                --card-h: 137px;
            }
            #title-img { display: none !important; }
            header {
                padding-top: 0.25rem !important;
                padding-bottom: 0.25rem !important;
                height: auto !important;
                min-height: 2.5rem;
            }
            #table-top {
                align-items: flex-start !important;
                padding-top: 2rem;
                padding-bottom: 4rem;
            }
            #deck-area {
                bottom: 0.5rem !important;
                transform: translateX(-50%) scale(0.8) !important;
            }
        }

        body {
            background-color: var(--paper-bg);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.1'/%3E%3C/svg%3E");
            color: var(--ink-black);
            font-family: 'Shippori Mincho', serif;
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            touch-action: none;
        }

        /* Typography */
        .headline {
            font-family: 'Playfair Display', serif;
            letter-spacing: -0.02em;
        }

        /* 3D Card Scene */
        .card-scene {
            width: var(--card-w);
            height: var(--card-h);
            perspective: 1000px;
            position: absolute;
            transform-style: preserve-3d;
            cursor: grab;
            opacity: 0;
            z-index: 10;
            /* â˜…é‡è¦: ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹è¨­å®š */
            pointer-events: auto;
            touch-action: none; 
            transition: width 0.3s, height 0.3s;
        }
        
        .card-scene:active {
            cursor: grabbing;
        }

        .card-obj {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            border-radius: 8px;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.4);
            pointer-events: none;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #444;
            background: #fff;
        }

        .card-face.front {
            transform: rotateY(180deg);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card-face.back {
            background: #2a2a2a;
            background-image: repeating-linear-gradient(45deg, #333 0, #333 1px, #444 0, #444 50%);
        }
        
        .card-face img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-obj.is-open {
            transform: rotateY(180deg);
        }

        /* Layout Areas */
        #table-top {
            position: relative;
            flex-grow: 1;
            width: 100%;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        #table-top::-webkit-scrollbar { 
            display: none; 
        }

        #spread-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            min-width: 100%;
            min-height: 100%;
            pointer-events: none;
            z-index: 20;
        }

        /* Deck */
        #deck-area {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            width: var(--card-w);
            height: var(--card-h);
            z-index: 30;
            transition: all 0.3s;
        }

        .deck-card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 8px;
            border: 1px solid #333;
            background: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        
        @keyframes shuffleShake {
            0% { transform: translateX(0) rotate(0); }
            25% { transform: translateX(-15px) rotate(-2deg); }
            50% { transform: translateX(0) rotate(0); }
            75% { transform: translateX(15px) rotate(2deg); }
            100% { transform: translateX(0) rotate(0); }
        }

        .shuffling .deck-card:nth-child(odd) {
            animation: shuffleShake 0.15s infinite alternate;
        }
        .shuffling .deck-card:nth-child(even) {
            animation: shuffleShake 0.15s infinite alternate-reverse;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 44, 44, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: grayscale(100%) blur(2px);
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .paper-modal {
            background: var(--paper-bg);
            border: 4px double var(--ink-black);
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.5);
            transform: scale(0.95);
            transition: transform 0.2s;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-overlay.active .paper-modal {
            transform: scale(1);
        }

        /* Full Screen Modal for Cards */
        .paper-modal.full-screen {
            width: 95%;
            height: 95%;
            max-width: 100%;
            max-height: 95vh;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .paper-btn {
            background: var(--ink-black);
            color: var(--paper-bg);
            border: none;
            padding: 10px 20px;
            font-family: 'Shippori Mincho', serif;
            font-weight: bold;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
        }
        .paper-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }
        .paper-btn.secondary {
            background: transparent;
            color: var(--ink-black);
            border: 2px solid var(--ink-black);
        }

        .paper-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--ink-black);
            padding: 10px;
            font-family: 'Shippori Mincho', serif;
            font-size: 1.1rem;
            color: var(--ink-black);
            outline: none;
            margin-bottom: 1rem;
            border-radius: 0;
        }

        /* Toast */
        #toast-container {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            width: 90%;
            pointer-events: none;
        }
        .toast {
            background: var(--ink-black);
            color: var(--paper-bg);
            padding: 12px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-family: 'Shippori Mincho', serif;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: slideDown 0.3s ease-out;
            pointer-events: auto;
            border: 1px solid var(--paper-bg);
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Header Date Line */
        .date-line {
            padding: 4px 0;
            margin-bottom: 10px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            font-family: 'Playfair Display', serif;
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        
        /* Guide Bubble */
        .bubble-pop {
            animation: popIn 0.3s ease-out forwards;
        }
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Guide Container Position - Moved above footer */
        #guide-container {
            padding-bottom: 0 !important; 
        }

    </style>
</head>
<body>

    <!-- Top Bar -->
    <header class="shrink-0 w-full px-4 pt-2 pb-1 z-50 bg-[#f4e4bc]/90 flex flex-col items-center shadow-sm transition-all duration-300">
        <div class="w-full flex justify-between items-center border-b-2 border-black/10 pb-1 mb-1 date-line">
             <span id="current-date" class="text-xs font-serif tracking-widest text-gray-700">VOL. I</span>
             <button id="btn-login-header" class="text-xs underline hover:text-red-900 font-bold cursor-pointer font-serif text-gray-800">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
        
        <!-- Title Image -->
        <img id="title-img" src="images/title.png" alt="The Daily Oracle" class="h-16 md:h-20 object-contain mb-1 drop-shadow-sm transition-all duration-300">

        <!-- Topic Display -->
        <div id="topic-display" class="hidden text-center border-t border-gray-400 pt-1 mt-1 w-full max-w-md">
            <span class="text-xs text-gray-600 mr-2">ãƒ†ãƒ¼ãƒ:</span>
            <span id="topic-text-content" class="font-bold text-ink-red truncate text-sm"></span>
        </div>
    </header>

    <!-- Main Table Area -->
    <main id="table-top" class="relative">
        <div id="toast-container"></div>

        <!-- Spread Layer -->
        <div id="spread-layer"></div>

        <!-- Deck Area -->
        <div id="deck-area">
            <!-- Visual stack of cards -->
            <div id="deck-stack" class="relative w-full h-full cursor-pointer">
                <!-- Multiple dummy cards -->
                <div class="deck-card" style="transform: translate(0, 0);">
                    <img id="deck-back-1" src="images/back.jpg" alt="" class="w-full h-full object-cover rounded">
                </div>
                <div class="deck-card" style="transform: translate(2px, 2px);">
                    <img id="deck-back-2" src="images/back.jpg" alt="" class="w-full h-full object-cover rounded">
                </div>
                <div class="deck-card" style="transform: translate(4px, 4px);">
                    <img id="deck-back-3" src="images/back.jpg" alt="" class="w-full h-full object-cover rounded">
                </div>
            </div>
        </div>

        <!-- Guide Character & Bubble -->
        <div id="guide-container" class="absolute bottom-0 right-0 z-50 p-2 md:p-4 pb-0 flex flex-col items-end pointer-events-none max-w-[70%] md:max-w-[40%]">
            <div id="guide-bubble" class="bg-[#2c2c2c] text-[#f4e4bc] p-3 md:p-4 rounded-2xl rounded-br-none mb-2 border-2 border-[#f4e4bc] shadow-lg transform origin-bottom-right bubble-pop relative mr-8">
                <p id="guide-text" class="font-bold text-xs md:text-base min-h-[1.5em] typing-cursor font-serif"></p>
                <div class="absolute -bottom-2 right-0 w-4 h-4 bg-[#2c2c2c] border-r-2 border-b-2 border-[#f4e4bc] transform rotate-45"></div>
            </div>
            
            <div class="w-28 h-28 md:w-40 md:h-40 relative mr-1 md:mr-2">
                 <img id="guide-img" src="images/seer.png" onerror="this.src='https://placehold.co/150x150/1e1b4b/d4af37?text=Seer'" class="w-full h-full object-contain opacity-100 drop-shadow-xl">
            </div>
        </div>

        <!-- Helper Character (Left Bottom) -->
        <div id="helper-container" class="absolute bottom-0 left-0 z-50 p-2 md:p-4 pb-0 flex flex-col items-start pointer-events-none max-w-[50%] md:max-w-[40%]">
            <!-- Bubble for Spread Help -->
            <div class="bg-[#2c2c2c] text-[#f4e4bc] p-1.5 px-2 rounded-2xl rounded-bl-none mb-1 border-2 border-[#f4e4bc] shadow-lg pointer-events-auto ml-2 relative">
                <button id="btn-help-spread" class="block text-[9px] text-yellow-300 hover:text-yellow-100 underline text-left font-serif leading-none whitespace-nowrap">ä¸¦ã¹æ–¹ã®è§£èª¬</button>
                <div class="absolute -bottom-1 left-0 w-2 h-2 bg-[#2c2c2c] border-l-2 border-b-2 border-[#f4e4bc] transform -rotate-45"></div>
            </div>

            <!-- Bubble for Card Help -->
            <div class="bg-[#2c2c2c] text-[#f4e4bc] p-1.5 px-2 rounded-2xl rounded-bl-none mb-1 border-2 border-[#f4e4bc] shadow-lg pointer-events-auto ml-6 relative">
                <button id="btn-help-card" class="block text-[9px] text-yellow-300 hover:text-yellow-100 underline text-left font-serif leading-none whitespace-nowrap">ã‚«ãƒ¼ãƒ‰ã®è§£èª¬</button>
                <div class="absolute -bottom-1 left-0 w-2 h-2 bg-[#2c2c2c] border-l-2 border-b-2 border-[#f4e4bc] transform -rotate-45"></div>
            </div>
            
            <div class="w-5 h-5 md:w-8 md:h-8 relative ml-1">
                 <img id="helper-img" src="images/helper.png" onerror="this.src='https://placehold.co/150x150/5c5c5c/f4e4bc?text=Helper'" class="w-full h-full object-contain opacity-100 drop-shadow-xl transform scale-x-[-1]">
            </div>
        </div>

    </main>

    <!-- Control Footer -->
    <footer class="shrink-0 w-full bg-[#f4e4bc] border-t-2 border-black p-3 z-50 h-20">
        <div class="flex flex-wrap justify-between items-center gap-2 max-w-md mx-auto">
            
            <div class="relative flex-grow">
                <select id="spread-select" class="w-full bg-transparent border-2 border-black px-2 py-2 font-serif text-sm focus:outline-none rounded-none cursor-pointer appearance-none">
                    <option value="one_oracle">ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ« (1æš)</option>
                    <option value="two_oracle">ğŸ”’ ãƒ„ãƒ¼ã‚ªãƒ©ã‚¯ãƒ« (2æš)</option>
                    <option value="two_mind">ğŸ”’ ãƒ„ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ (2æš)</option>
                    <option value="simple_cross">ğŸ”’ ã‚·ãƒ³ãƒ—ãƒ«ã‚¯ãƒ­ã‚¹ (2æš)</option>
                    <option value="three_card">ğŸ”’ ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ (3æš)</option>
                    <option value="four_card">ğŸ”’ ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰ (4æš)</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                    <i class="fa-solid fa-caret-down"></i>
                </div>
            </div>

            <button id="btn-shuffle" class="paper-btn">
                ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            </button>
            
            <button id="btn-open" class="paper-btn secondary" disabled style="opacity: 0.5;">
                é–‹ã
            </button>
            
            <button id="btn-reset" class="paper-btn secondary hidden">
                ã‚‚ã†ä¸€åº¦
            </button>

            <button id="btn-share" class="paper-btn bg-white text-black border-2 border-black hidden items-center gap-2">
                <i class="fa-solid fa-share-nodes"></i>
            </button>
        </div>
    </footer>

    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="paper-modal">
            <h2 class="headline text-2xl mb-4 border-b-2 border-black pb-2">ä¼šå“¡ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <p class="text-sm mb-6 text-gray-700">
                ã“ã¡ã‚‰ã¯ Save Point ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è€…å‘ã‘ã§ã™ã€‚<br>
            </p>
            
            <input type="text" id="login-id" class="paper-input" placeholder="ID (ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹)">
            <input type="password" id="login-pass" class="paper-input" placeholder="Password">
            
            <div id="login-error" class="text-red-700 text-sm mb-4 hidden">IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div>

            <div class="flex flex-col gap-3 mt-4">
                <button id="btn-submit-login" class="paper-btn w-full">èªè¨¼ã™ã‚‹</button>
                <div class="flex justify-between items-center text-xs mt-2">
                    <button id="link-forgot-pass" class="underline text-blue-800 hover:text-blue-600">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸ</button>
                    <a href="https://savepoint.design4qol.com" target="_blank" class="underline text-blue-800 hover:text-blue-600">æ–°è¦ç™»éŒ²ã™ã‚‹</a>
                </div>
                <button id="btn-close-login" class="underline text-sm text-gray-600 mt-2">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="reset-modal" class="modal-overlay">
        <div class="paper-modal">
            <h2 class="headline text-2xl mb-4 border-b-2 border-black pb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š</h2>
            <p class="text-sm mb-6 text-gray-700">
                ç™»éŒ²ã—ã¦ã„ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
                å†è¨­å®šç”¨ã®ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã™ã€‚
            </p>
            
            <input type="email" id="reset-email" class="paper-input" placeholder="Email Address">
            
            <div id="reset-msg" class="text-sm mb-4 hidden"></div>

            <div class="flex flex-col gap-3 mt-4">
                <button id="btn-submit-reset" class="paper-btn w-full">é€ä¿¡</button>
                <button id="btn-close-reset" class="underline text-sm text-gray-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- Topic Input Modal -->
    <div id="topic-modal" class="modal-overlay">
        <div class="paper-modal">
            <h2 class="headline text-2xl mb-4 border-b-2 border-black pb-2">å ã„ã®ãƒ†ãƒ¼ãƒ</h2>
            <p class="text-sm mb-6 text-gray-700 text-left">
                ä»Šæ—¥ã‚ãªãŸã¯ä½•ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿ<br>
                çµæœã¯é‹å–¶å…ƒã¸è¨˜éŒ²ãƒ»é€ä¿¡ã•ã‚Œã¾ã™ã€‚
            </p>
            
            <input type="text" id="topic-input" class="paper-input" placeholder="ä¾‹: ä»Šå¾Œã®ã‚­ãƒ£ãƒªã‚¢ã«ã¤ã„ã¦...">

            <div class="flex flex-col gap-3 mt-4">
                <button id="btn-submit-topic" class="paper-btn w-full">å ã„ã‚’å§‹ã‚ã‚‹</button>
                <button id="btn-cancel-topic" class="underline text-sm text-gray-600">ã‚¹ã‚­ãƒƒãƒ— (ãƒ†ãƒ¼ãƒãªã—)</button>
            </div>
        </div>
    </div>

    <!-- Spread Help Modal -->
    <div id="spread-help-modal" class="modal-overlay">
        <div class="paper-modal text-left">
            <h2 class="headline text-2xl mb-4 border-b-2 border-black pb-2">é…åˆ—ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼‰è§£èª¬</h2>
            <div class="text-sm mb-6 text-gray-700 space-y-3 h-64 overflow-y-auto pr-2">
                <p class="text-xs">
                    <strong>ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«:</strong> ã‚·ãƒ³ãƒ—ãƒ«ãª1æšå¼•ãã€‚ã‚¤ã‚¨ã‚¹ãƒ»ãƒãƒ¼ã‚„ä¸€æ—¥ã®é‹å‹¢ã«ã€‚<br>
                    <strong>ãƒ„ãƒ¼ã‚ªãƒ©ã‚¯ãƒ«:</strong> çµæœã¨å¯¾ç­–ã€‚å•é¡Œã®åŸå› ã¨è§£æ±ºã®ç³¸å£ã‚’æ¢ã‚Šã¾ã™ã€‚<br>
                    <strong>ãƒ„ãƒ¼ãƒã‚¤ãƒ³ãƒ‰:</strong> é¡•åœ¨æ„è­˜ã¨æ½œåœ¨æ„è­˜ã€‚è‡ªåˆ†ã®æœ¬å½“ã®æ°—æŒã¡ã‚’çŸ¥ã‚ŠãŸã„æ™‚ã«ã€‚<br>
                    <strong>ã‚·ãƒ³ãƒ—ãƒ«ã‚¯ãƒ­ã‚¹:</strong> ç¾çŠ¶ã¨éšœå®³ã€‚ä½•ãŒé“ã‚’é˜»ã‚“ã§ã„ã‚‹ã®ã‹ã‚’æ˜ç¢ºã«ã—ã¾ã™ã€‚<br>
                    <strong>ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰:</strong> éå»ãƒ»ç¾åœ¨ãƒ»æœªæ¥ã€‚æ™‚é–“ã®æµã‚Œã«æ²¿ã£ã¦çŠ¶æ³ã‚’èª­ã¿è§£ãã¾ã™ã€‚<br>
                    <strong>ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰:</strong> å•é¡Œè§£æ±ºã€‚ç¾çŠ¶ã€éšœå®³ã€å¯¾ç­–ã€çµæœã®4æšã§æ·±ãåˆ†æã—ã¾ã™ã€‚
                </p>
                <div class="mt-4 p-2 bg-gray-100 rounded text-xs">
                    ã‚ˆã‚Šè©³ã—ã„è§£èª¬ã¯ä¼šå“¡ã‚µã‚¤ãƒˆ(Save Point)ã‚’ã”è¦§ãã ã•ã„ã€‚
                </div>
            </div>
            <div class="text-center">
                <button id="btn-close-spread-help" class="paper-btn w-full">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- â˜… NEW: Card Help Modal (Full Screen with Details) -->
    <div id="card-help-modal" class="modal-overlay">
        <div class="paper-modal full-screen bg-[#f4e4bc] relative flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center border-b-4 double border-black p-4 shrink-0 bg-[#f4e4bc] z-10">
                <h2 class="headline text-xl md:text-2xl font-bold">å¤§ã‚¢ãƒ«ã‚«ãƒŠè§£èª¬</h2>
                <button id="btn-close-card-help" class="text-2xl font-bold p-2 hover:text-red-700 transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- Scrollable Content -->
            <div class="flex-grow overflow-y-auto p-4 space-y-8 pb-20">
                <!-- 0. The Fool -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/0.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=0';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">0. æ„šè€… (The Fool)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> å§‹ã¾ã‚Šã€è‡ªç”±ã€ç„¡é‚ªæ°—ã€å†’é™ºã€ç„¡è¨ˆç”»ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€ŒãŠã£ã¡ã‚‡ã“ã¡ã‚‡ã„ãªè²·ã„ç‰©ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">è²¡å¸ƒã‚’å¿˜ã‚Œã¦è²·ã„ç‰©ã«å‡ºã‹ã‘ã‚‹ä¸»å©¦ã€‚è¶³å…ƒã®æ®µå·®ã§ã¤ã¾ãšããã†ã ãŒã€ç©ºã«ã¯ã®ã©ã‹ãªå¤ªé™½ã€‚è‡ªç”±ã§ç„¡é‚ªæ°—ãªã‚¹ã‚¿ãƒ¼ãƒˆã€‚</p>
                    </div>
                </div>

                <!-- 1. The Magician -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/1.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=1';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">I. é­”è¡“å¸« (The Magician)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> å‰µé€ æ€§ã€æŠ€è¡“ã€é“å…·ã‚’ä½¿ã„ã“ãªã™ã€è‡ªä¿¡ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œæ—¥æ›œå¤§å·¥ã®ãŠçˆ¶ã•ã‚“ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">åº­ã§ç›†æ ½ã®æ‰‹å…¥ã‚Œã‚„æ—¥æ›œå¤§å·¥ã‚’ã™ã‚‹é ‘å›ºè¦ªçˆ¶ã€‚ä½œæ¥­å°ã«ã¯å››å¤§è¦ç´ ï¼ˆé‡‘æ§Œã€æ¹¯å‘‘ã¿ã€ãƒã‚µãƒŸã€å°éŠ­ï¼‰ãŒä¸¦ã¶ã€‚å‰µé€ ã¨æŠ€è¡“ã®è±¡å¾´ã€‚</p>
                    </div>
                </div>

                <!-- 2. The High Priestess -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/2.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=2';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">II. å¥³æ•™çš‡ (The High Priestess)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> çŸ¥æµã€é™å¯‚ã€ç›´æ„Ÿã€ç¥ç§˜ã€å‹‰å­¦ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œé™ã‹ãªã‚‹æ¯ã®çŸ¥æµã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">ç¸å´ã§é™ã‹ã«ç¹•ã„ç‰©ã‚„å®¶è¨ˆç°¿ã‚’ã¤ã‘ã‚‹æ¯ã€‚åºŠã®é–“ã«ã¯æ›ã‘è»¸ãŒã‚ã‚Šã€é™ã‹ãªçŸ¥æ€§ã‚’æ„Ÿã˜ã•ã›ã‚‹ã€‚</p>
                    </div>
                </div>

                <!-- 3. The Empress -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/3.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=3';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">III. å¥³å¸ (The Empress)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> è±Šç©£ã€æ¯æ€§ã€å®¶åº­ã®ç¹æ „ã€æ„›ã€ç¾ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œè‹¥å¥¥æ§˜ã®å¥®é—˜ã¨å¹¸ã›ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">å±±ç››ã‚Šã®é£Ÿæã«å›²ã¾ã‚Œã¦æ–™ç†ã™ã‚‹è‹¥å¥¥æ§˜ã€‚è¶³å…ƒã§å­ä¾›ãŒå…ƒæ°—ã«éŠã¶ã€è±Šã‹ã§æ´»æ°—ã‚ã‚‹å®¶åº­ã®è±¡å¾´ã€‚</p>
                    </div>
                </div>

                <!-- 4. The Emperor -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/4.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=4';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">IV. çš‡å¸ (The Emperor)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> çˆ¶æ€§ã€æ¨©å¨ã€ç§©åºã€å®‰å®šã€è²¬ä»»ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œé«˜åº¦çµŒæ¸ˆæˆé•·ã®æˆ¦å£«ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">ã‚ªãƒ•ã‚£ã‚¹ã§é»’é›»è©±ã§æŒ‡ç¤ºã‚’å‡ºã™æ°å¹…ã®è‰¯ã„ä¸Šå¸ã€‚èƒŒæ™¯ã«ã¯ãƒ“ãƒ«å»ºè¨­ã®é¢¨æ™¯ã€‚é ¼ã‚ŠãŒã„ã®ã‚ã‚‹ãƒªãƒ¼ãƒ€ãƒ¼ã€‚</p>
                    </div>
                </div>

                <!-- 5. The Hierophant -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/5.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=5';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">V. æ•™çš‡ (The Hierophant)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> ä¼çµ±ã€æ•™ãˆã€ç¤¾ä¼šè¦ç¯„ã€åŠ©è¨€è€…ã€å…ˆç”Ÿã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œå…ˆç”Ÿã®æ›¸æ–ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">æ›¸æ–ã§ãƒ‘ã‚¤ãƒ—ã‚’ãã‚†ã‚‰ã›ãªãŒã‚‰èªã‚‹å°èª¬å®¶ã®å…ˆç”Ÿã€‚æ•™ãˆã‚’ä¹ã†è‹¥è€…ãŸã¡ã€‚çŸ¥è­˜ã¨è‰¯è­˜ã®è±¡å¾´ã€‚</p>
                    </div>
                </div>

                <!-- 6. The Lovers -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/6.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=6';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">VI. æ‹äººãŸã¡ (The Lovers)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> æ„›ã€èª¿å’Œã€é¸æŠã€ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œé‹å‘½ã®ãŠè¦‹åˆã„ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">ãƒ‡ãƒ‘ãƒ¼ãƒˆã®é£Ÿå ‚ã§å‘ã‹ã„åˆã†è‹¥ã„äºŒäººã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ã‚¯ãƒªãƒ¼ãƒ ã‚½ãƒ¼ãƒ€ã€‚ä»²äººãŒãƒ‹ã‚³ãƒ‹ã‚³ã¨è¦‹å®ˆã‚‹ã€‚</p>
                    </div>
                </div>

                <!-- 7. The Chariot -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/7.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=7';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">VII. æˆ¦è»Š (The Chariot)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> å‹åˆ©ã€å‰é€²ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€æ„å¿—ã®å¼·ã•ã€ç§»å‹•ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œå¾¡ç”¨èãã¯ã¤ã‚‰ã„ã‚ˆã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">é‡ãŸã„è·ç‰©ã‚’ç©ã‚“ã è‡ªè»¢è»Šã§å‚é“ã‚’æ¼•ãé…é”å“¡ã€‚æ±—ã ãã«ãªã‚ŠãªãŒã‚‰ã‚‚åŠ›å¼·ãå‰é€²ã™ã‚‹å§¿ã€‚</p>
                    </div>
                </div>

                <!-- 8. Strength -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/8.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=8';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">VIII. åŠ› (Strength)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> å†…ãªã‚‹åŠ›ã€å¿è€ã€å„ªã—ã•ã«ã‚ˆã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€å‹‡æ°—ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œå„ªã—ã•ã¯å¼·ã•ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">æš´ã‚Œã‚ˆã†ã¨ã™ã‚‹çŒ«ã‚’å„ªã—ãæŠ±ãã—ã‚ã¦ãªã ã‚ã‚‹å°‘å¥³ã€‚åŠ›ã¥ãã§ã¯ãªãã€å„ªã—ã•ã§ç›¸æ‰‹ã‚’è½ã¡ç€ã‹ã›ã‚‹ã€‚</p>
                    </div>
                </div>

                <!-- 9. The Hermit -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/9.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=9';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">IX. éš è€… (The Hermit)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> å†…çœã€æ¢æ±‚ã€å­¤ç‹¬ã€æŒ‡å°è€…ã€çœŸç†ã‚’æ±‚ã‚ã‚‹ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œæ·±å¤œã®å—é¨“å‹‰å¼·ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">æ·±å¤œã€å°ã•ãªæ˜ã‹ã‚Šã®ä¸‹ã§å‚è€ƒæ›¸ã¨æ ¼é—˜ã™ã‚‹æµªäººç”Ÿã€‚å­¤ç‹¬ãªæˆ¦ã„ã¨å†…çœã®æ™‚é–“ã€‚</p>
                    </div>
                </div>

                <!-- 10. Wheel of Fortune -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/10.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=10';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">X. é‹å‘½ã®è¼ª (Wheel of Fortune)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> å¤‰åŒ–ã€ã‚µã‚¤ã‚¯ãƒ«ã€é‹å‘½ã®æµ®ãæ²ˆã¿ã€ãƒãƒ£ãƒ³ã‚¹ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œå®¶æ—å›£ã‚‰ã‚“ã®ã¡ã‚ƒã¶å°ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">å›è»¢ã™ã‚‹ã¡ã‚ƒã¶å°ã®å‘¨ã‚Šã«ã€æœãƒ»æ˜¼ãƒ»å¤•ãƒ»å¤œã®å®¶æ—ã®å–¶ã¿ã¨ã€å››å­£ã®ã‚¢ã‚¤ã‚³ãƒ³ã€‚å·¡ã‚Šã‚†ãæ—¥å¸¸ã®ã‚µã‚¤ã‚¯ãƒ«ã€‚</p>
                    </div>
                </div>

                <!-- 11. Justice -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/11.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=11';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">XI. æ­£ç¾© (Justice)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> å…¬å¹³ã€å‡è¡¡ã€åŸå› ã¨çµæœã€æ³•å¾‹ã€æ­£ã—ã•ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œç”ºã®å¹³å’Œã‚’å®ˆã‚‹äººã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">äº¤ç•ªã®å‰ã§æ•¬ç¤¼ã™ã‚‹ãŠã¾ã‚ã‚Šã•ã‚“ã€‚è­¦æ£’ã¨è½ã¨ã—ç‰©ãƒãƒ¼ãƒˆã‚’æŒã¡ã€å…¬å¹³ãªè¦–ç‚¹ã§ç”ºã‚’è¦‹å®ˆã‚‹ã€‚</p>
                    </div>
                </div>

                <!-- 12. The Hanged Man -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/12.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=12';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">XII. åŠã‚‹ã•ã‚ŒãŸç”· (The Hanged Man)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> è©¦ç·´ã€å¿è€ã€è¦–ç‚¹ã‚’å¤‰ãˆã‚‹ã€è‡ªå·±çŠ ç‰²ã€å‹•ã‘ãªã„çŠ¶æ…‹ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œã‚µãƒ©ãƒªãƒ¼ãƒãƒ³ã®å—é›£ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">æº€å“¡é›»è»Šã§ã¤ã‚Šé©ã«ã¶ã‚‰ä¸‹ãŒã‚Šè€ãˆã‚‹ã‚µãƒ©ãƒªãƒ¼ãƒãƒ³ã€‚è‹¦ã—ãã†ã ãŒæ‚Ÿã‚Šã‚’é–‹ã„ãŸè¡¨æƒ…ã€‚è‡ªå·±çŠ ç‰²ã€‚</p>
                    </div>
                </div>

                <!-- 13. Death -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/13.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=13';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">XIII. æ­»ç¥ (Death)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> çµ‚ç„‰ã€å¤‰åŒ–ã€æ–°ã—ã„å§‹ã¾ã‚Šã€æ–­æ¨é›¢ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œã„ãŸãšã‚‰ã€ãƒãƒ¬ã‚‹ï¼ˆå¤§ç›®ç‰ï¼‰ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">çˆ¶è¦ªã«é›·ã‚’è½ã¨ã•ã‚Œã‚‹è…•ç™½åŠä¸»ã€‚éŒã®ä»£ã‚ã‚Šã«ä¸¸ã‚ãŸæ–°èç´™ã€‚å¹³ç©ãªæ™‚é–“ã®çµ‚ã‚ã‚Šã¨ãŠèª¬æ•™ã‚¿ã‚¤ãƒ ã®å§‹ã¾ã‚Šã€‚</p>
                    </div>
                </div>

                <!-- 14. Temperance -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/14.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=14';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">XIV. ç¯€åˆ¶ (Temperance)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> èª¿æ•´ã€ãƒãƒ©ãƒ³ã‚¹ã€çµ±åˆã€ç©ã‚„ã‹ã•ã€ä¸­åº¸ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œå™‚è©±ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">äº•æˆ¸ç«¯ä¼šè­°ã‚’ã™ã‚‹ä¸»å©¦ãŸã¡ã€‚æƒ…å ±ã‚’æµã—ã€äººé–“é–¢ä¿‚ã‚’èª¿æ•´ã™ã‚‹æ—¥å¸¸ã®ãƒãƒ©ãƒ³ã‚¹æ„Ÿè¦šã€‚</p>
                    </div>
                </div>

                <!-- 15. The Devil -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/15.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=15';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">XV. æ‚ªé­” (The Devil)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> èª˜æƒ‘ã€æ¬²æœ›ã€æŸç¸›ã€ä¾å­˜ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œã¤ã¾ã¿é£Ÿã„ã®èª˜æƒ‘ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">æšã’ãŸã¦ã®ã‚³ãƒ­ãƒƒã‚±ã«æ‰‹ã‚’ä¼¸ã°ã™å­ä¾›ã¨çŒ«ã€‚ç›®ã«ã¯æ¬²æœ›ã®ç‚ã€‚ã€Œé£Ÿã„æ„åœ°ã€ã¨ã„ã†é–ã€‚</p>
                    </div>
                </div>

                <!-- 16. The Tower -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/16.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=16';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">XVI. å¡” (The Tower)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> çªç„¶ã®å´©å£Šã€äºˆæœŸã›ã¬å‡ºæ¥äº‹ã€ã‚·ãƒ§ãƒƒã‚¯ã€å•“ç¤ºã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œãƒ‰ã‚¿ãƒã‚¿å¤§æƒ¨äº‹ï¼ˆãµã™ã¾å€’ã—ï¼‰ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">è¿½ã„ã‹ã‘ã£ã“ã§éšœå­ã«æ¿€çªã—å€’å£Šã€‚èˆã„æ•£ã‚‹éšœå­ç´™ã¨é©šãå®¶æ—ã€‚æ—¥å¸¸ã®ä¸­ã®çªç„¶ã®ãƒãƒ—ãƒ‹ãƒ³ã‚°ã€‚</p>
                    </div>
                </div>

                <!-- 17. The Star -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/17.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=17';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">XVII. æ˜Ÿ (The Star)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> å¸Œæœ›ã€ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ç™’ã—ã€ç´”ç²‹ã•ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œè¦‹ä¸Šã’ã¦ã”ã‚‰ã‚“å¤œã®æ˜Ÿã‚’ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">å¤ã®å¤œã€ç¸å´ã§å¤œç©ºã‚’è¦‹ä¸Šã’ã‚‹å­ä¾›ãŸã¡ã€‚å¤§ããªä¸€ç•ªæ˜ŸãŒå¸Œæœ›ã‚’ç…§ã‚‰ã™ã€‚è¶³å…ƒã«ã¯èŠ±ç«ã®ãƒã‚±ãƒ„ã€‚</p>
                    </div>
                </div>

                <!-- 18. The Moon -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/18.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=18';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">XVIII. æœˆ (The Moon)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> ä¸å®‰ã€å¹»æƒ³ã€æ½œåœ¨æ„è­˜ã€æ›–æ˜§ã•ã€å¤œã®ä¸–ç•Œã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œå¤œã®ç”ºã®æ€ªã—ã„å½±ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">æ·±å¤œã®è·¯åœ°è£ã€‚æ³¥æ£’ã¨é…”ã£æ‰•ã„ã®ã‚·ãƒ«ã‚¨ãƒƒãƒˆã€‚é‡è‰¯çŠ¬ã¨çŒ«ãŒå¯¾å³™ã™ã‚‹ã€å°‘ã—ä¸å®‰ãªå¤œã®é¡”ã€‚</p>
                    </div>
                </div>

                <!-- 19. The Sun -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/19.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=19';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">XIX. å¤ªé™½ (The Sun)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> æˆåŠŸã€å–œã³ã€æ´»åŠ›ã€ç„¡é‚ªæ°—ã•ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œç©ºãåœ°ã®é‡çƒå¤§ä¼šã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ã‚’æ‰“ã£ã¦æ­“å£°ã‚’ä¸Šã’ã‚‹å­ä¾›ãŸã¡ã€‚å…¥é“é›²ã¨ãƒ‹ã‚³ãƒ‹ã‚³ç¬‘ã†å¤ªé™½ã€‚çˆ†ç™ºçš„ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨å–œã³ã€‚</p>
                    </div>
                </div>

                <!-- 20. Judgement -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/20.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=20';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">XX. å¯©åˆ¤ (Judgement)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> å¾©æ´»ã€è¦šé†’ã€å‘¼ã³ã‹ã‘ã€çµæœãŒå‡ºã‚‹ã€æ–°ã—ã„æ®µéšã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œæœã®ç›®è¦šã‚ã¨ãƒ©ãƒƒãƒ‘ã®éŸ³ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">ç›®è¦šã¾ã—æ™‚è¨ˆãŒé³´ã‚ŠéŸ¿ãã€å¸ƒå›£ã‹ã‚‰é£›ã³èµ·ãã‚‹å®¶æ—ã€‚æ–°ã—ã„ä¸€æ—¥ï¼ˆæ–°ã—ã„æ®µéšï¼‰ã¸ã®å¼·åˆ¶çš„ãªç›®è¦šã‚ã€‚</p>
                    </div>
                </div>

                <!-- 21. The World -->
                <div class="flex flex-col md:flex-row gap-4 border-b border-black/20 pb-6">
                    <img src="images/21.jpg" class="w-24 md:w-32 rounded shadow-md object-cover border border-black mx-auto md:mx-0 bg-gray-300" onerror="this.src='https://placehold.co/100x170?text=21';">
                    <div class="text-left flex-1">
                        <h3 class="font-bold text-lg mb-2 font-serif">XXI. ä¸–ç•Œ (The World)</h3>
                        <p class="text-sm mb-1"><strong>ä¼çµ±çš„ãªæ„å‘³:</strong> å®Œæˆã€é”æˆã€çµ±åˆã€ãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰ã€å®Œç’§ãªèª¿å’Œã€‚</p>
                        <p class="text-sm mb-1"><strong>ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ã€Œæ—¥æ›œæ—¥ã®å¤•æ–¹ï¼ˆã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ã€</p>
                        <p class="text-xs text-gray-700 leading-relaxed">å®¶æ—å…¨å“¡ãŒãƒªã‚ºãƒ ã«åˆã‚ã›ã¦å®¶ã¸å…¥ã£ã¦ã„ãå¾Œã‚å§¿ã€‚ä¸€ã¤ã®ã‚µã‚¤ã‚¯ãƒ«ã®å®Œæˆã¨ã€å¤‰ã‚ã‚‰ãªã„æ—¥å¸¸ã®å¹¸ã›ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * THE DAILY ORACLE - APP LOGIC
         */

        // ==========================================
        //  CONFIG
        // ==========================================
        const IMG_FOLDER = 'images/';  
        const IMG_EXT = '.jpg';        
        const BACK_IMG = 'back.jpg';
        const SEER_IMG = 'seer.png'; 
        const HELPER_IMG = 'helper.png'; 
        
        // â˜… Google Apps Script URL
        const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzFidZHGCpxVsoJ9tMzjg3oFpZwiPEkyiZR7Pv5O242lRieemSF7vAEihsJbv29NF7t/exec";

        const TOTAL_CARDS = 22; 
        const SHUFFLE_CARD_COUNT = 40;
        
        const SPREAD_CONFIGS = {
            'one_oracle': { count: 1, pos: [{x:50, y:40}], loginReq: false },
            'two_oracle': { count: 2, pos: [{x:35, y:40}, {x:65, y:40}], loginReq: true },
            'two_mind':   { count: 2, pos: [{x:50, y:25}, {x:50, y:60}], loginReq: true },
            'simple_cross': { count: 2, pos: [{x:50, y:40}, {x:50, y:40, cross: true}], loginReq: true },
            'three_card': { count: 3, pos: [{x:20, y:40}, {x:50, y:40}, {x:80, y:40}], loginReq: true },
            'four_card':  { count: 4, pos: [{x:25, y:25}, {x:75, y:25}, {x:25, y:60}, {x:75, y:60}], loginReq: true }
        };
        
        const VALID_ID = "admin";
        const VALID_PASS = "secret";

        // --- State ---
        let deck = [];
        let drawnCards = [];
        let currentSpread = 'one_oracle';
        let currentState = 'IDLE'; 
        let pickCount = 0;
        let isLoggedIn = false;
        let currentTopic = "";
        let lastValidSpread = 'one_oracle';
        let typeInterval;
        let isDragging = false;
        let currentDragCard = null;
        let startX, startY, initialLeft, initialTop;
        
        let loginUser = { name: '', email: '' };

        // --- DOM Elements ---
        const uiSpreadSelect = document.getElementById('spread-select');
        const uiBtnShuffle = document.getElementById('btn-shuffle');
        const uiBtnOpen = document.getElementById('btn-open');
        const uiBtnReset = document.getElementById('btn-reset');
        const uiBtnShare = document.getElementById('btn-share');
        
        const uiDeckStack = document.getElementById('deck-stack');
        const uiDeckArea = document.getElementById('deck-area');
        const uiSpreadLayer = document.getElementById('spread-layer');
        const uiTopicDisplay = document.getElementById('topic-display');
        const uiTopicText = document.getElementById('topic-text-content');
        const uiDate = document.getElementById('current-date');
        const uiToastContainer = document.getElementById('toast-container');
        
        const uiGuideText = document.getElementById('guide-text');
        const uiGuideBubble = document.getElementById('guide-bubble');
        const uiGuideImg = document.getElementById('guide-img');
        const uiHelperImg = document.getElementById('helper-img');
        const uiDeckImgs = [
            document.getElementById('deck-back-1'),
            document.getElementById('deck-back-2'),
            document.getElementById('deck-back-3')
        ];

        const uiLoginModal = document.getElementById('login-modal');
        const uiResetModal = document.getElementById('reset-modal');
        const uiTopicModal = document.getElementById('topic-modal');
        
        // Help Modals
        const uiSpreadHelpModal = document.getElementById('spread-help-modal');
        const uiCardHelpModal = document.getElementById('card-help-modal');
        
        const uiLoginId = document.getElementById('login-id');
        const uiLoginPass = document.getElementById('login-pass');
        const uiLoginError = document.getElementById('login-error');
        const uiTopicInput = document.getElementById('topic-input');
        const uiResetEmail = document.getElementById('reset-email');
        const uiResetMsg = document.getElementById('reset-msg');
        
        const uiBtnSubmitLogin = document.getElementById('btn-submit-login');
        const uiLinkForgotPass = document.getElementById('link-forgot-pass');
        const uiBtnSubmitReset = document.getElementById('btn-submit-reset');

        // --- Init ---
        function init() {
            // Set Date
            const d = new Date();
            uiDate.innerText = `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()} ç™ºè¡Œ`;

            setupImages();
            populateDeck();
            
            // Event Listeners
            uiSpreadSelect.addEventListener('change', handleSpreadChange);
            
            document.getElementById('btn-login-header').addEventListener('click', () => {
                if(isLoggedIn) handleLogout();
                else showModal(uiLoginModal);
            });
            
            uiBtnSubmitLogin.addEventListener('click', handleLoginSubmit);
            document.getElementById('btn-close-login').addEventListener('click', () => hideModal(uiLoginModal));
            
            uiLinkForgotPass.addEventListener('click', () => {
                hideModal(uiLoginModal);
                showModal(uiResetModal);
            });
            
            uiBtnSubmitReset.addEventListener('click', handleResetSubmit);
            document.getElementById('btn-close-reset').addEventListener('click', () => {
                hideModal(uiResetModal);
                showModal(uiLoginModal);
            });
            
            document.getElementById('btn-submit-topic').addEventListener('click', handleTopicSubmit);
            document.getElementById('btn-cancel-topic').addEventListener('click', () => {
                currentTopic = "ãƒ†ãƒ¼ãƒãªã—"; 
                hideModal(uiTopicModal);
                updateTopicUI();
                setStatus("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚’é¸ã‚“ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãã ã•ã„ã€‚");
            });
            
            // Helper Events
            document.getElementById('btn-help-spread').addEventListener('click', () => showModal(uiSpreadHelpModal));
            document.getElementById('btn-close-spread-help').addEventListener('click', () => hideModal(uiSpreadHelpModal));
            
            document.getElementById('btn-help-card').addEventListener('click', () => showModal(uiCardHelpModal));
            document.getElementById('btn-close-card-help').addEventListener('click', () => hideModal(uiCardHelpModal));


            uiBtnShuffle.addEventListener('click', startShuffle);
            uiDeckStack.addEventListener('click', handleDeckClick);
            uiBtnOpen.addEventListener('click', startReveal);
            
            uiBtnReset.addEventListener('click', () => resetGame(true));
            
            uiBtnShare.addEventListener('click', handleNativeShare);
            
            // Drag Events
            document.addEventListener('mousedown', handleDragStart);
            document.addEventListener('touchstart', handleDragStart, {passive: false});
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('touchmove', handleDragMove, {passive: false});
            document.addEventListener('mouseup', handleDragEnd);
            document.addEventListener('touchend', handleDragEnd);
            
            window.addEventListener('resize', handleResize);

            setStatus("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼ˆä¸¦ã¹æ–¹ï¼‰ã‚’é¸ã‚“ã§é–‹å§‹ã—ã¦ãã ã•ã„ã€‚");
        }

        // --- Logic ---
        
        function handleResize() {
            if (drawnCards.length > 0 && (currentState === 'PICKING' || currentState === 'READY' || currentState === 'FINISHED')) {
                setTimeout(repositionCards, 200);
            }
        }

        function repositionCards() {
            const conf = SPREAD_CONFIGS[currentSpread];
            const spreadRect = uiSpreadLayer.getBoundingClientRect();
            
            drawnCards.forEach((item, index) => {
                const el = item.el;
                const pos = conf.pos[index];
                
                const cardW = el.offsetWidth;
                const cardH = el.offsetHeight;

                const targetX = (spreadRect.width * (pos.x / 100)) - (cardW / 2);
                const targetY = (spreadRect.height * (pos.y / 100)) - (cardH / 2);
                
                el.style.transition = 'left 0.3s, top 0.3s';
                el.style.left = `${targetX}px`;
                el.style.top = `${targetY}px`;
            });
        }
        
        function setupImages() {
            if(uiGuideImg) uiGuideImg.src = IMG_FOLDER + SEER_IMG;
            if(uiHelperImg) uiHelperImg.src = IMG_FOLDER + HELPER_IMG;
            uiDeckImgs.forEach(img => { if(img) img.src = IMG_FOLDER + BACK_IMG; });
        }

        function populateDeck() {
            deck = [];
            for(let i=0; i<=21; i++) deck.push(i); 
        }

        function handleSpreadChange(e) {
            const val = e.target.value;
            const conf = SPREAD_CONFIGS[val];
            
            if (conf.loginReq && !isLoggedIn) {
                showModal(uiLoginModal);
                uiSpreadSelect.value = lastValidSpread;
                return;
            }
            currentSpread = val;
            lastValidSpread = val;
            resetGame(false); 
        }

        function handleLoginSubmit() {
            const id = uiLoginId.value;
            const pass = uiLoginPass.value;
            if(!id || !pass) return;

            uiBtnSubmitLogin.disabled = true;
            uiBtnSubmitLogin.innerText = "èªè¨¼ä¸­...";
            uiLoginError.classList.add('hidden');

            const payload = {
                type: 'auth',
                id: id,
                password: pass
            };

            fetch(API_ENDPOINT, {
                method: 'POST',
                redirect: 'follow', 
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    isLoggedIn = true;
                    loginUser.name = data.username || "User";
                    loginUser.email = data.email || id;
                    hideModal(uiLoginModal);
                    updateLoginStateUI();
                    showToast("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚", "success");
                    resetGame(false);
                } else {
                    const msg = data.message ? `ã‚¨ãƒ©ãƒ¼: ${data.message}` : "IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
                    uiLoginError.innerText = msg;
                    uiLoginError.classList.remove('hidden');
                }
            })
            .catch(err => {
                console.error(err);
                if(id === "admin" && pass === "secret") {
                     isLoggedIn = true;
                     loginUser.name = "Demo User";
                     loginUser.email = "demo@example.com";
                     hideModal(uiLoginModal);
                     updateLoginStateUI();
                     showToast("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚(Demo)", "success");
                     resetGame(false);
                } else {
                     uiLoginError.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
                     uiLoginError.classList.remove('hidden');
                }
            })
            .finally(() => {
                uiBtnSubmitLogin.disabled = false;
                uiBtnSubmitLogin.innerText = "èªè¨¼ã™ã‚‹";
            });
        }
        
        function handleResetSubmit() {
            const email = uiResetEmail.value;
            if(!email) return;
            
            uiResetMsg.classList.remove('hidden');
            uiResetMsg.classList.remove('text-red-600');
            uiResetMsg.classList.add('text-gray-600');
            uiResetMsg.innerText = "é€ä¿¡ä¸­...";
            
            const payload = {
                type: 'reset',
                email: email
            };
            
            fetch(API_ENDPOINT, {
                method: 'POST',
                redirect: 'follow', 
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    uiResetMsg.innerText = "å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚";
                } else {
                    uiResetMsg.classList.add('text-red-600');
                    uiResetMsg.innerText = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                }
            })
            .catch(err => {
                 uiResetMsg.classList.add('text-red-600');
                 uiResetMsg.innerText = "é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            });
        }

        function handleLogout() {
            if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                isLoggedIn = false;
                updateLoginStateUI();
                currentSpread = 'one_oracle';
                lastValidSpread = 'one_oracle';
                uiSpreadSelect.value = 'one_oracle';
                currentTopic = ""; 
                resetGame(true);
            }
        }

        function updateLoginStateUI() {
            const btn = document.getElementById('btn-login-header');
            const opts = uiSpreadSelect.options;

            if(isLoggedIn) {
                btn.innerText = "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ";
                for(let i=0; i<opts.length; i++) {
                    opts[i].text = opts[i].text.replace("ğŸ”’ ", "");
                }
            } else {
                btn.innerText = "ãƒ­ã‚°ã‚¤ãƒ³";
                 for(let i=0; i<opts.length; i++) {
                    const val = opts[i].value;
                    const conf = SPREAD_CONFIGS[val];
                    if (conf && conf.loginReq && !opts[i].text.includes("ğŸ”’")) {
                        opts[i].text = "ğŸ”’ " + opts[i].text;
                    }
                }
            }
        }

        function handleTopicSubmit() {
            currentTopic = uiTopicInput.value.trim();
            hideModal(uiTopicModal);
            updateTopicUI();
            setStatus(`ãƒ†ãƒ¼ãƒ: ã€Œ${currentTopic}ã€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`);
        }

        function updateTopicUI() {
            if(currentTopic) {
                uiTopicDisplay.classList.remove('hidden');
                uiTopicText.innerText = currentTopic;
            } else {
                uiTopicDisplay.classList.add('hidden');
            }
        }

        function startShuffle() {
            if(currentState !== 'IDLE' && currentState !== 'FINISHED') return;
            
            if(isLoggedIn && currentState === 'IDLE' && !currentTopic) {
                if(uiTopicInput) uiTopicInput.value = "";
                showModal(uiTopicModal);
                return;
            }

            currentState = 'SHUFFLING';
            uiDeckStack.classList.add('shuffling'); 
            uiBtnShuffle.disabled = true;
            uiSpreadSelect.disabled = true;
            
            uiSpreadLayer.innerHTML = '';
            drawnCards = [];
            pickCount = 0;
            
            setStatus("å±±æœ­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ã¦ãã ã•ã„ï¼");
        }

        function handleDeckClick() {
            if (currentState === 'SHUFFLING' || currentState === 'PICKING') {
                pickOneCard();
            }
        }

        function pickOneCard() {
            const conf = SPREAD_CONFIGS[currentSpread];
            if (pickCount >= conf.count) return;

            currentState = 'PICKING';
            uiDeckStack.classList.remove('shuffling');

            if(deck.length === 0) populateDeck();
            const rIndex = Math.floor(Math.random() * deck.length);
            const cardId = deck[rIndex];
            deck.splice(rIndex, 1);
            const isReversed = Math.random() < 0.5;

            const el = document.createElement('div');
            el.className = 'card-scene';
            el.style.opacity = '1';
            
            el.innerHTML = `
                <div class="card-obj">
                    <div class="card-face front">
                        <img src="${IMG_FOLDER}${cardId}${IMG_EXT}" 
                             style="transform: ${isReversed ? 'rotate(180deg)' : 'none'};"
                             onerror="this.src='https://placehold.co/100x174/eee/333?text=${cardId}'">
                    </div>
                    <div class="card-face back">
                        <img src="${IMG_FOLDER}${BACK_IMG}" onerror="this.src='https://placehold.co/100x174/333/eee?text=BACK'">
                    </div>
                </div>
            `;
            uiSpreadLayer.appendChild(el);
            drawnCards.push({ id: cardId, reversed: isReversed, el: el });

            // Animate
            const deckRect = uiDeckStack.getBoundingClientRect();
            const spreadRect = uiSpreadLayer.getBoundingClientRect();
            
            const startX = (spreadRect.width / 2) - (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-w'))/2); 
            const startY = spreadRect.height - 150; 

            el.style.left = `${startX}px`;
            el.style.top = `${startY}px`;
            el.style.opacity = '1';

            const pos = conf.pos[pickCount];
            const targetX = (spreadRect.width * (pos.x / 100)) - (el.offsetWidth / 2);
            const targetY = (spreadRect.height * (pos.y / 100)) - (el.offsetHeight / 2);

            el.offsetHeight; 

            requestAnimationFrame(() => {
                el.style.transition = "all 0.5s ease-out";
                el.style.left = `${targetX}px`;
                el.style.top = `${targetY}px`;
                
                if(pos.cross) {
                    el.style.transform = "rotate(90deg)";
                }
            });

            pickCount++;

            if (pickCount >= conf.count) {
                currentState = 'READY';
                uiBtnOpen.disabled = false;
                uiBtnOpen.style.opacity = 1;
                // â˜… Hide Deck when done
                uiDeckStack.classList.add('hidden'); 
                
                setStatus("ã‚«ãƒ¼ãƒ‰ãŒæƒã„ã¾ã—ãŸã€‚ã€Œé–‹ãã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            } else {
                setTimeout(() => {
                     if(currentState === 'PICKING') uiDeckStack.classList.add('shuffling');
                }, 500);
            }
        }

        function startReveal() {
            if (currentState !== 'READY') return;
            currentState = 'OPENING';
            uiBtnOpen.disabled = true;
            setStatus("é‹å‘½ã‚’ç´è§£ã„ã¦ã„ã¾ã™...");

            let delay = 0;
            drawnCards.forEach((c) => {
                setTimeout(() => {
                    const obj = c.el.querySelector('.card-obj');
                    obj.classList.add('is-open');
                }, delay);
                delay += 800;
            });

            setTimeout(() => {
                currentState = 'FINISHED';
                uiBtnShare.classList.remove('hidden');
                uiBtnShare.classList.add('flex');
                uiBtnReset.classList.remove('hidden');
                uiBtnShuffle.classList.add('hidden');
                uiBtnOpen.classList.add('hidden');
                
                setStatus("ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†ã€‚ã‚«ãƒ¼ãƒ‰ã‚’å‹•ã‹ã—ã¦ç¢ºèªã§ãã¾ã™ã€‚");

                if(isLoggedIn) {
                    sendDataToGAS();
                }
            }, delay + 500);
        }

        function resetGame(fullReset = false) {
            // Logic for full reset (AGAIN button) vs soft reset (Spread change)
            if (fullReset) {
                currentTopic = ""; 
                updateTopicUI();
            }

            // If logged in and topic missing, prompt
            if(isLoggedIn && !currentTopic && fullReset) {
                if(uiTopicInput) uiTopicInput.value = "";
                showModal(uiTopicModal);
            }

            uiSpreadLayer.innerHTML = '';
            drawnCards = [];
            currentState = 'IDLE';
            populateDeck();
            
            pickCount = 0; 

            uiBtnShuffle.disabled = false;
            uiBtnShuffle.classList.remove('hidden');
            
            uiBtnOpen.disabled = true;
            uiBtnOpen.classList.remove('hidden');
            uiBtnOpen.style.opacity = 0.5;

            uiBtnReset.classList.add('hidden');
            
            uiBtnShare.classList.add('hidden');
            uiBtnShare.classList.remove('flex');

            uiSpreadSelect.disabled = false;
            uiDeckStack.classList.remove('hidden');
            uiDeckStack.classList.remove('shuffling');
            
            if(!isLoggedIn) setStatus("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼ˆä¸¦ã¹æ–¹ï¼‰ã‚’é¸ã‚“ã§é–‹å§‹ã—ã¦ãã ã•ã„ã€‚");
            else if(!currentTopic) setStatus("ãƒ†ãƒ¼ãƒã‚’è¨­å®šã—ã¦å ã„ã‚’é–‹å§‹ã—ã¾ã™ã€‚");
            else setStatus("ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚");
        }

        // --- Drag Implementation ---
        function handleDragStart(e) {
            if (currentState !== 'FINISHED') return;
            // Mouse left click only
            if (e.type === 'mousedown' && e.button !== 0) return;

            // Find valid card target
            const targetEl = e.target.closest('.card-scene');
            if (!targetEl) return;

            const evt = e.type.includes('mouse') ? e : e.touches[0];

            isDragging = true;
            currentDragCard = targetEl;

            currentDragCard.style.zIndex = 100;
            currentDragCard.style.transition = 'none';

            initialLeft = parseFloat(currentDragCard.style.left) || 0;
            initialTop = parseFloat(currentDragCard.style.top) || 0;

            startX = evt.clientX;
            startY = evt.clientY;
            
            if (e.type === 'touchstart') {
                e.preventDefault(); 
            }
        }

        function handleDragMove(e) {
            if (!isDragging || !currentDragCard) return;

            const evt = e.type.includes('mouse') ? e : e.touches[0];
            const dx = evt.clientX - startX;
            const dy = evt.clientY - startY;

            currentDragCard.style.left = `${initialLeft + dx}px`;
            currentDragCard.style.top = `${initialTop + dy}px`;
            
            if(e.cancelable) e.preventDefault();
        }

        function handleDragEnd(e) {
            if (!isDragging) return;
            if(currentDragCard) {
                currentDragCard.style.zIndex = 50;
            }
            isDragging = false;
            currentDragCard = null;
        }

        // --- Utils ---

        function showModal(el) {
            el.classList.add('active');
        }
        function hideModal(el) {
            el.classList.remove('active');
        }
        
        function showToast(msg, type='info') {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerHTML = msg;
            if(type==='success') t.style.borderLeftColor = 'lightgreen';
            uiToastContainer.appendChild(t);
            setTimeout(() => {
                t.style.opacity = 0;
                setTimeout(()=>t.remove(), 300);
            }, 3000);
        }

        async function handleNativeShare() {
            const url = "https://tarot.design4qol.com/";
            const text = `ğŸ”® ä»Šæ—¥ã®é‹å‘½ (The Daily Oracle)\nTheme: ${currentTopic || 'My Destiny'}`;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'The Daily Oracle',
                        text: text,
                        url: url
                    });
                } catch (err) {
                    // Share cancelled
                }
            } else {
                if(navigator.clipboard) {
                    navigator.clipboard.writeText(`${text} ${url}`);
                    showToast("ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
                } else {
                    showToast("ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã¯å…±æœ‰æ©Ÿèƒ½ãŒä½¿ãˆã¾ã›ã‚“ã€‚");
                }
            }
        }

        function sendDataToGAS() {
            if(!API_ENDPOINT) return;
            
            showToast("é‹å–¶ã¸é€ä¿¡å®Œäº†ã€‚è§£èª¬ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚", "success");

            const payload = {
                type: 'save',
                date: new Date().toISOString(),
                theme: currentTopic,
                spread: currentSpread,
                cards: drawnCards.map(c => ({ id: c.id, reversed: c.reversed }))
            };

            fetch(API_ENDPOINT, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            }).then(() => {
                // Already toasted
            }).catch(e => {
                console.error(e);
            });
        }
        
        function setStatus(msg) {
            if(uiGuideBubble) {
                uiGuideBubble.classList.remove('bubble-pop');
                void uiGuideBubble.offsetWidth; 
                uiGuideBubble.classList.add('bubble-pop');
            }
            if(uiGuideText) {
                uiGuideText.textContent = '';
                clearInterval(typeInterval);
                
                let i = 0;
                typeInterval = setInterval(() => {
                    uiGuideText.textContent += msg.charAt(i);
                    i++;
                    if (i >= msg.length) {
                        clearInterval(typeInterval);
                    }
                }, 50); 
            }
        }

        init();

    </script>
</body>
</html>
