<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚·ãƒ§ã‚¦ãƒ¯ãƒ¬ãƒˆãƒ­ãƒƒãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Fonts & Variables --- */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Shippori+Mincho:wght@400;700&display=swap');
        :root {
            --paper-bg: #f4e4bc;
            --ink-black: #2c2c2c;
            --ink-red: #8b0000;
            --card-w: 160px; --card-h: 274px;
        }
        @media (min-width: 375px) { :root { --card-w: 180px; --card-h: 308px; } }
        @media (orientation: landscape) and (max-height: 600px) {
            :root { --card-w: 80px; --card-h: 137px; }
            #title-img { display: none !important; }
            header { padding: 0.25rem !important; height: auto !important; min-height: 2.5rem; }
            #table-top { padding: 2rem 0 4rem; align-items: flex-start !important; }
            #deck-area { bottom: 0.5rem !important; transform: translateX(-50%) scale(0.8) !important; }
        }

        /* --- Global Styles --- */
        body {
            background-color: var(--paper-bg);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.1'/%3E%3C/svg%3E");
            color: var(--ink-black);
            font-family: 'Shippori Mincho', serif;
            overflow: hidden; height: 100vh; height: 100dvh;
            display: flex; flex-direction: column; touch-action: none;
        }
        .headline { font-family: 'Playfair Display', serif; letter-spacing: -0.02em; }

        /* --- Card & Scene --- */
        .card-scene {
            width: var(--card-w); height: var(--card-h);
            perspective: 1000px; position: absolute;
            transform-style: preserve-3d; cursor: grab;
            opacity: 0; z-index: 10; pointer-events: auto;
            touch-action: none; transition: width 0.3s, height 0.3s;
        }
        .card-scene:active { cursor: grabbing; }
        .card-obj {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; border-radius: 8px;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 4px 4px 10px rgba(0,0,0,0.4); pointer-events: none;
        }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 8px;
            overflow: hidden; border: 1px solid #444; background: #fff;
        }
        .card-face.front { transform: rotateY(180deg); display: flex; justify-content: center; align-items: center; }
        .card-face.back {
            background: #2a2a2a;
            background-image: repeating-linear-gradient(45deg, #333 0, #333 1px, #444 0, #444 50%);
        }
        .card-face img { width: 100%; height: 100%; object-fit: cover; }
        .card-obj.is-open { transform: rotateY(180deg); }

        /* --- Layout Areas --- */
        #table-top {
            position: relative; flex-grow: 1; width: 100%;
            overflow: auto; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        #table-top::-webkit-scrollbar { display: none; }
        #spread-layer { position: absolute; inset: 0; pointer-events: none; z-index: 20; }
        #deck-area {
            position: absolute; bottom: 2rem; left: 50%;
            transform: translateX(-50%); width: var(--card-w); height: var(--card-h);
            z-index: 30; transition: all 0.3s;
        }
        .deck-card {
            position: absolute; inset: 0; border-radius: 8px;
            border: 1px solid #333; background: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); transition: transform 0.1s;
        }
        
        /* --- Animations --- */
        @keyframes shuffleShake {
            0%, 50%, 100% { transform: translateX(0) rotate(0); }
            25% { transform: translateX(-15px) rotate(-2deg); }
            75% { transform: translateX(15px) rotate(2deg); }
        }
        .shuffling .deck-card:nth-child(odd) { animation: shuffleShake 0.15s infinite alternate; }
        .shuffling .deck-card:nth-child(even) { animation: shuffleShake 0.15s infinite alternate-reverse; }
        .bubble-pop { animation: popIn 0.3s ease-out forwards; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .typing-cursor::after { content: '|'; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* --- UI Components --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(44, 44, 44, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; backdrop-filter: grayscale(100%) blur(2px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .paper-modal {
            background: var(--paper-bg); border: 4px double var(--ink-black);
            padding: 1.5rem; width: 90%; max-width: 400px; text-align: center;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.5); transform: scale(0.95);
            transition: transform 0.2s; max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.active .paper-modal { transform: scale(1); }
        
        .paper-btn {
            background: var(--ink-black); color: var(--paper-bg); border: none;
            padding: 10px 20px; font-family: 'Shippori Mincho', serif;
            font-weight: bold; letter-spacing: 1px; cursor: pointer;
            transition: all 0.2s; box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
        }
        .paper-btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 rgba(0,0,0,0.3); }
        .paper-btn.secondary { background: transparent; color: var(--ink-black); border: 2px solid var(--ink-black); }
        .paper-input {
            width: 100%; background: transparent; border: none;
            border-bottom: 2px solid var(--ink-black); padding: 10px;
            font-family: 'Shippori Mincho', serif; font-size: 1.1rem;
            color: var(--ink-black); outline: none; margin-bottom: 1rem; border-radius: 0;
        }

        #toast-container { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 90%; pointer-events: none; }
        .toast {
            background: var(--ink-black); color: var(--paper-bg); padding: 12px 20px;
            margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-family: 'Shippori Mincho', serif; display: flex; align-items: center; justify-content: center;
            animation: slideDown 0.3s ease-out; pointer-events: auto; border: 1px solid var(--paper-bg);
        }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .date-line { padding: 4px 0; margin-bottom: 10px; display: flex; justify-content: flex-end; align-items: center; font-family: 'Playfair Display', serif; font-size: 0.8rem; text-transform: uppercase; }
        #guide-container { padding-bottom: 0 !important; bottom: 0 !important; }
    </style>
</head>
<body>

    <header class="shrink-0 w-full px-4 pt-2 pb-1 z-50 bg-[#f4e4bc]/90 flex flex-col items-center shadow-sm transition-all duration-300">
        <div class="w-full flex justify-between items-center border-b-2 border-black/10 pb-1 mb-1 date-line">
             <span id="current-date" class="text-xs font-serif tracking-widest text-gray-700">VOL. I</span>
             <button id="btn-login-header" class="text-xs underline hover:text-red-900 font-bold cursor-pointer font-serif text-gray-800">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
        <img id="title-img" src="images/title.png" alt="The Daily Oracle" class="h-16 md:h-20 object-contain mb-1 drop-shadow-sm transition-all duration-300">
        <div id="topic-display" class="hidden text-center border-t border-gray-400 pt-1 mt-1 w-full max-w-md">
            <span class="text-xs text-gray-600 mr-2">ãƒ†ãƒ¼ãƒ:</span>
            <span id="topic-text-content" class="font-bold text-ink-red truncate text-sm"></span>
        </div>
    </header>

    <main id="table-top">
        <div id="toast-container"></div>
        <div id="spread-layer"></div>
        <div id="deck-area">
            <div id="deck-stack" class="relative w-full h-full cursor-pointer">
                <div class="deck-card" style="transform: translate(0, 0);"><img id="deck-back-1" src="" class="w-full h-full object-cover rounded"></div>
                <div class="deck-card" style="transform: translate(2px, 2px);"><img id="deck-back-2" src="" class="w-full h-full object-cover rounded"></div>
                <div class="deck-card" style="transform: translate(4px, 4px);"><img id="deck-back-3" src="" class="w-full h-full object-cover rounded"></div>
            </div>
        </div>
        <div id="guide-container" class="absolute bottom-0 right-0 z-50 p-2 md:p-4 pb-0 flex flex-col items-end pointer-events-none max-w-[70%] md:max-w-[40%]">
            <div id="guide-bubble" class="bg-[#2c2c2c] text-[#f4e4bc] p-3 md:p-4 rounded-2xl rounded-br-none mb-2 border-2 border-[#f4e4bc] shadow-lg transform origin-bottom-right bubble-pop relative mr-8">
                <p id="guide-text" class="font-bold text-xs md:text-base min-h-[1.5em] typing-cursor font-serif"></p>
                <div class="absolute -bottom-2 right-0 w-4 h-4 bg-[#2c2c2c] border-r-2 border-b-2 border-[#f4e4bc] transform rotate-45"></div>
            </div>
            <div class="w-28 h-28 md:w-40 md:h-40 relative mr-1 md:mr-2">
                 <img id="guide-img" src="" class="w-full h-full object-contain opacity-100 drop-shadow-xl">
            </div>
        </div>
    </main>

    <footer class="shrink-0 w-full bg-[#f4e4bc] border-t-2 border-black p-3 z-50 h-20">
        <div class="flex flex-wrap justify-between items-center gap-2 max-w-md mx-auto">
            <div class="relative flex-grow">
                <select id="spread-select" class="w-full bg-transparent border-2 border-black px-2 py-2 font-serif text-sm focus:outline-none rounded-none cursor-pointer appearance-none">
                    <option value="one_oracle">ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ« (1æš)</option>
                    <option value="two_oracle">ğŸ”’ ãƒ„ãƒ¼ã‚ªãƒ©ã‚¯ãƒ« (2æš)</option>
                    <option value="two_mind">ğŸ”’ ãƒ„ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ (2æš)</option>
                    <option value="simple_cross">ğŸ”’ ã‚·ãƒ³ãƒ—ãƒ«ã‚¯ãƒ­ã‚¹ (2æš)</option>
                    <option value="three_card">ğŸ”’ ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ (3æš)</option>
                    <option value="four_card">ğŸ”’ ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰ (4æš)</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none"><i class="fa-solid fa-caret-down"></i></div>
            </div>
            <button id="btn-shuffle" class="paper-btn">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
            <button id="btn-open" class="paper-btn secondary" disabled style="opacity: 0.5;">é–‹ã</button>
            <button id="btn-reset" class="paper-btn secondary hidden">ã‚‚ã†ä¸€åº¦</button>
            <button id="btn-share" class="paper-btn bg-white text-black border-2 border-black hidden items-center gap-2"><i class="fa-solid fa-share-nodes"></i></button>
        </div>
    </footer>

    <div id="login-modal" class="modal-overlay">
        <div class="paper-modal">
            <h2 class="headline text-2xl mb-4 border-b-2 border-black pb-2">ä¼šå“¡ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <input type="text" id="login-id" class="paper-input" placeholder="ID (ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹)">
            <input type="password" id="login-pass" class="paper-input" placeholder="Password">
            <div id="login-error" class="text-red-700 text-sm mb-4 hidden">IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div>
            <div class="flex flex-col gap-3 mt-4">
                <button id="btn-submit-login" class="paper-btn w-full">èªè¨¼ã™ã‚‹</button>
                <div class="flex justify-between items-center text-xs mt-2">
                    <button id="link-forgot-pass" class="underline text-blue-800 hover:text-blue-600">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸ</button>
                </div>
                <button id="btn-close-login" class="underline text-sm text-gray-600 mt-2">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="reset-modal" class="modal-overlay">
        <div class="paper-modal">
            <h2 class="headline text-2xl mb-4 border-b-2 border-black pb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š</h2>
            <input type="email" id="reset-email" class="paper-input" placeholder="Email Address">
            <div id="reset-msg" class="text-sm mb-4 hidden"></div>
            <div class="flex flex-col gap-3 mt-4">
                <button id="btn-submit-reset" class="paper-btn w-full">é€ä¿¡</button>
                <button id="btn-close-reset" class="underline text-sm text-gray-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <div id="topic-modal" class="modal-overlay">
        <div class="paper-modal">
            <h2 class="headline text-2xl mb-4 border-b-2 border-black pb-2">å ã„ã®ãƒ†ãƒ¼ãƒ</h2>
            <p class="text-sm mb-6 text-gray-700 text-left">ä»Šæ—¥ã‚ãªãŸã¯ä½•ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿ</p>
            <input type="text" id="topic-input" class="paper-input" placeholder="ä¾‹: ä»Šå¾Œã®ã‚­ãƒ£ãƒªã‚¢ã«ã¤ã„ã¦...">
            <div class="flex flex-col gap-3 mt-4">
                <button id="btn-submit-topic" class="paper-btn w-full">å ã„ã‚’å§‹ã‚ã‚‹</button>
                <button id="btn-cancel-topic" class="underline text-sm text-gray-600">ã‚¹ã‚­ãƒƒãƒ— (ãƒ†ãƒ¼ãƒãªã—)</button>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šã‚¨ãƒªã‚¢ ---
        const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbyUzEB9fFwV80OO6N8HJeLP9R7jP78VuolwT3rkPQcHln1mSjJ3wnGdNcnIrRpwUsvN/exec"; 
        
        const IMG_FOLDER = 'images/';
        const IMG_EXT = '.jpg';
        const BACK_IMG = 'back.jpg';
        const SEER_IMG = 'seer.png';

        const SPREAD_CONFIGS = {
            'one_oracle':   { count: 1, pos: [{x:50, y:40}], loginReq: false },
            'two_oracle':   { count: 2, pos: [{x:35, y:40}, {x:65, y:40}], loginReq: true },
            'two_mind':     { count: 2, pos: [{x:50, y:25}, {x:50, y:60}], loginReq: true },
            'simple_cross': { count: 2, pos: [{x:50, y:40}, {x:50, y:40, cross: true}], loginReq: true },
            'three_card':   { count: 3, pos: [{x:20, y:40}, {x:50, y:40}, {x:80, y:40}], loginReq: true },
            'four_card':    { count: 4, pos: [{x:25, y:25}, {x:75, y:25}, {x:25, y:60}, {x:75, y:60}], loginReq: true }
        };

        // --- ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç† ---
        let deck = [];
        let drawnCards = [];
        let currentSpread = 'one_oracle';
        let currentState = 'IDLE'; 
        let pickCount = 0;
        let isLoggedIn = false;
        let loginUser = { name: '', email: '' };
        let currentTopic = "";
        let lastValidSpread = 'one_oracle';
        
        // --- UIè¦ç´ å–å¾— ---
        const els = {
            select: document.getElementById('spread-select'),
            btnShuffle: document.getElementById('btn-shuffle'),
            btnOpen: document.getElementById('btn-open'),
            btnReset: document.getElementById('btn-reset'),
            btnShare: document.getElementById('btn-share'),
            deckStack: document.getElementById('deck-stack'),
            spreadLayer: document.getElementById('spread-layer'),
            topicDisplay: document.getElementById('topic-display'),
            topicText: document.getElementById('topic-text-content'),
            guideText: document.getElementById('guide-text'),
            guideBubble: document.getElementById('guide-bubble'),
            guideImg: document.getElementById('guide-img'),
            deckImgs: [document.getElementById('deck-back-1'), document.getElementById('deck-back-2'), document.getElementById('deck-back-3')],
            loginModal: document.getElementById('login-modal'),
            resetModal: document.getElementById('reset-modal'),
            topicModal: document.getElementById('topic-modal'),
            loginId: document.getElementById('login-id'),
            loginPass: document.getElementById('login-pass'),
            loginError: document.getElementById('login-error')
        };

        // --- åˆæœŸåŒ– ---
        function init() {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('ja-JP') + " ç™ºè¡Œ";
            if(els.guideImg) els.guideImg.src = IMG_FOLDER + SEER_IMG;
            els.deckImgs.forEach(img => { if(img) img.src = IMG_FOLDER + BACK_IMG; });
            populateDeck();

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            els.select.addEventListener('change', handleSpreadChange);
            document.getElementById('btn-login-header').addEventListener('click', () => isLoggedIn ? handleLogout() : showModal(els.loginModal));
            
            // ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£
            document.getElementById('btn-submit-login').addEventListener('click', handleLoginSubmit);
            document.getElementById('btn-close-login').addEventListener('click', () => hideModal(els.loginModal));
            document.getElementById('link-forgot-pass').addEventListener('click', () => { hideModal(els.loginModal); showModal(els.resetModal); });
            document.getElementById('btn-submit-reset').addEventListener('click', handleResetSubmit);
            document.getElementById('btn-close-reset').addEventListener('click', () => hideModal(els.resetModal));

            // ãƒ†ãƒ¼ãƒé–¢é€£
            document.getElementById('btn-submit-topic').addEventListener('click', () => {
                currentTopic = document.getElementById('topic-input').value.trim();
                hideModal(els.topicModal); updateTopicUI(); setStatus(`ãƒ†ãƒ¼ãƒ: ã€Œ${currentTopic}ã€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`);
            });
            document.getElementById('btn-cancel-topic').addEventListener('click', () => {
                currentTopic = "ãƒ†ãƒ¼ãƒãªã—"; hideModal(els.topicModal); updateTopicUI(); setStatus("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚’é¸ã‚“ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãã ã•ã„ã€‚");
            });

            // ã‚²ãƒ¼ãƒ æ“ä½œ
            els.btnShuffle.addEventListener('click', startShuffle);
            els.deckStack.addEventListener('click', () => (currentState === 'SHUFFLING' || currentState === 'PICKING') && pickOneCard());
            els.btnOpen.addEventListener('click', startReveal);
            els.btnReset.addEventListener('click', () => resetGame(true));
            els.btnShare.addEventListener('click', handleNativeShare);

            // ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œ
            document.addEventListener('mousedown', handleDragStart);
            document.addEventListener('touchstart', handleDragStart, {passive: false});
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('touchmove', handleDragMove, {passive: false});
            document.addEventListener('mouseup', handleDragEnd);
            document.addEventListener('touchend', handleDragEnd);
            window.addEventListener('resize', () => currentState !== 'OPENING' && repositionCards());

            setStatus("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼ˆä¸¦ã¹æ–¹ï¼‰ã‚’é¸ã‚“ã§é–‹å§‹ã—ã¦ãã ã•ã„ã€‚");
        }

        // --- APIé€£æº (Core) ---
        async function callGasApi(payload) {
            try {
                const res = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    redirect: 'follow', // GASã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¿½è·¡
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // GASã®CORSå¯¾ç­–
                    body: JSON.stringify(payload)
                });
                return await res.json();
            } catch (err) {
                console.error("API Error:", err);
                throw err;
            }
        }

        function handleLoginSubmit() {
            const id = els.loginId.value;
            const pass = els.loginPass.value;
            if(!id || !pass) return;

            const btn = document.getElementById('btn-submit-login');
            btn.disabled = true; btn.innerText = "èªè¨¼ä¸­...";
            els.loginError.classList.add('hidden');

            callGasApi({ type: 'auth', id: id, password: pass })
                .then(data => {
                    if(data.status === 'success') {
                        isLoggedIn = true;
                        loginUser = { name: data.username, email: id };
                        hideModal(els.loginModal);
                        updateLoginStateUI();
                        showToast("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚", "success");
                        resetGame(false);
                    } else {
                        els.loginError.innerText = data.message || "èªè¨¼å¤±æ•—";
                        els.loginError.classList.remove('hidden');
                    }
                })
                .catch(() => { els.loginError.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼"; els.loginError.classList.remove('hidden'); })
                .finally(() => { btn.disabled = false; btn.innerText = "èªè¨¼ã™ã‚‹"; });
        }

        function handleResetSubmit() {
            const email = document.getElementById('reset-email').value;
            const msgEl = document.getElementById('reset-msg');
            if(!email) return;
            
            msgEl.className = 'text-sm mb-4 text-gray-600';
            msgEl.innerText = "é€ä¿¡ä¸­...";
            
            callGasApi({ type: 'reset', email: email })
                .then(data => {
                    msgEl.innerText = data.status === 'success' ? "å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚" : "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                    if(data.status !== 'success') msgEl.classList.add('text-red-600');
                })
                .catch(() => { msgEl.innerText = "é€ä¿¡ã‚¨ãƒ©ãƒ¼"; msgEl.classList.add('text-red-600'); });
        }

        function sendDataToGAS() {
            if(!API_ENDPOINT) return;
            const payload = {
                type: 'save',
                date: new Date().toISOString(),
                username: loginUser.name,
                email: loginUser.email,
                theme: currentTopic,
                spread: currentSpread,
                cards: drawnCards.map(c => ({ id: c.id, reversed: c.reversed }))
            };
            callGasApi(payload).then(()=> showToast("é‹å–¶ã¸è¨˜éŒ²ã•ã‚Œã¾ã—ãŸã€‚", "success")).catch(e => console.error(e));
        }

        // --- ãƒ­ã‚¸ãƒƒã‚¯ ---
        function populateDeck() { deck = Array.from({length: 22}, (_, i) => i); }
        
        function handleSpreadChange(e) {
            const val = e.target.value;
            if (SPREAD_CONFIGS[val].loginReq && !isLoggedIn) {
                showModal(els.loginModal);
                els.select.value = lastValidSpread;
                return;
            }
            currentSpread = val; lastValidSpread = val; resetGame(false);
        }

        function updateLoginStateUI() {
            const btn = document.getElementById('btn-login-header');
            const opts = els.select.options;
            btn.innerText = isLoggedIn ? "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" : "ãƒ­ã‚°ã‚¤ãƒ³";
            for(let opt of opts) {
                const conf = SPREAD_CONFIGS[opt.value];
                if(isLoggedIn) opt.text = opt.text.replace("ğŸ”’ ", "");
                else if(conf.loginReq && !opt.text.includes("ğŸ”’")) opt.text = "ğŸ”’ " + opt.text;
            }
        }

        function handleLogout() {
            if(!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
            isLoggedIn = false; loginUser = {name:'', email:''};
            updateLoginStateUI();
            currentSpread = 'one_oracle'; els.select.value = 'one_oracle';
            currentTopic = ""; resetGame(true);
        }

        function startShuffle() {
            if(currentState !== 'IDLE' && currentState !== 'FINISHED') return;
            if(isLoggedIn && !currentTopic) { document.getElementById('topic-input').value = ""; showModal(els.topicModal); return; }
            
            currentState = 'SHUFFLING';
            els.deckStack.classList.add('shuffling'); 
            els.btnShuffle.disabled = true; els.select.disabled = true;
            els.spreadLayer.innerHTML = ''; drawnCards = []; pickCount = 0;
            setStatus("å±±æœ­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ã¦ãã ã•ã„ï¼");
        }

        function pickOneCard() {
            const conf = SPREAD_CONFIGS[currentSpread];
            if (pickCount >= conf.count) return;
            
            currentState = 'PICKING'; els.deckStack.classList.remove('shuffling');
            if(deck.length === 0) populateDeck();
            
            const rIndex = Math.floor(Math.random() * deck.length);
            const cardId = deck.splice(rIndex, 1)[0];
            const isReversed = Math.random() < 0.5;
            
            // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
            const el = document.createElement('div');
            el.className = 'card-scene';
            el.innerHTML = `
                <div class="card-obj">
                    <div class="card-face front"><img src="${IMG_FOLDER}${cardId}${IMG_EXT}" style="transform: ${isReversed ? 'rotate(180deg)' : 'none'};"></div>
                    <div class="card-face back"><img src="${IMG_FOLDER}${BACK_IMG}"></div>
                </div>`;
            
            els.spreadLayer.appendChild(el);
            drawnCards.push({ id: cardId, reversed: isReversed, el: el });
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä½ç½®è¨ˆç®—
            const deckRect = els.deckStack.getBoundingClientRect();
            const spreadRect = els.spreadLayer.getBoundingClientRect();
            const startX = (spreadRect.width/2) - (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-w'))/2);
            el.style.left = `${startX}px`; el.style.top = `${spreadRect.height - 150}px`; el.style.opacity = '1';
            
            requestAnimationFrame(() => {
                const pos = conf.pos[pickCount];
                const tx = (spreadRect.width * (pos.x/100)) - (el.offsetWidth/2);
                const ty = (spreadRect.height * (pos.y/100)) - (el.offsetHeight/2);
                el.style.transition = "all 0.5s ease-out";
                el.style.left = `${tx}px`; el.style.top = `${ty}px`;
                if(pos.cross) el.style.transform = "rotate(90deg)";
            });

            pickCount++;
            if (pickCount >= conf.count) {
                currentState = 'READY';
                els.btnOpen.disabled = false; els.btnOpen.style.opacity = 1;
                els.deckStack.classList.add('hidden');
                setStatus("ã‚«ãƒ¼ãƒ‰ãŒæƒã„ã¾ã—ãŸã€‚ã€Œé–‹ãã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            } else {
                setTimeout(() => { if(currentState === 'PICKING') els.deckStack.classList.add('shuffling'); }, 500);
            }
        }

        function startReveal() {
            if (currentState !== 'READY') return;
            currentState = 'OPENING'; els.btnOpen.disabled = true;
            setStatus("é‹å‘½ã‚’ç´è§£ã„ã¦ã„ã¾ã™...");
            
            let delay = 0;
            drawnCards.forEach((c) => {
                setTimeout(() => c.el.querySelector('.card-obj').classList.add('is-open'), delay);
                delay += 800;
            });

            setTimeout(() => {
                currentState = 'FINISHED';
                els.btnShare.classList.remove('hidden'); els.btnShare.classList.add('flex');
                els.btnReset.classList.remove('hidden');
                els.btnShuffle.classList.add('hidden'); els.btnOpen.classList.add('hidden');
                setStatus("ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†ã€‚ã‚«ãƒ¼ãƒ‰ã‚’å‹•ã‹ã—ã¦ç¢ºèªã§ãã¾ã™ã€‚");
                if(isLoggedIn) sendDataToGAS();
            }, delay + 500);
        }

        function repositionCards() {
            const conf = SPREAD_CONFIGS[currentSpread];
            const spreadRect = els.spreadLayer.getBoundingClientRect();
            drawnCards.forEach((item, index) => {
                const pos = conf.pos[index];
                item.el.style.left = `${(spreadRect.width * (pos.x/100)) - (item.el.offsetWidth/2)}px`;
                item.el.style.top = `${(spreadRect.height * (pos.y/100)) - (item.el.offsetHeight/2)}px`;
            });
        }

        function resetGame(fullReset) {
            if(fullReset) { currentTopic = ""; updateTopicUI(); }
            if(isLoggedIn && !currentTopic && fullReset) { document.getElementById('topic-input').value=""; showModal(els.topicModal); }
            
            els.spreadLayer.innerHTML = ''; drawnCards = []; currentState = 'IDLE'; pickCount = 0; populateDeck();
            
            els.btnShuffle.classList.remove('hidden'); els.btnShuffle.disabled = false;
            els.btnOpen.classList.remove('hidden'); els.btnOpen.disabled = true; els.btnOpen.style.opacity = 0.5;
            els.btnReset.classList.add('hidden'); els.btnShare.classList.add('hidden'); els.btnShare.classList.remove('flex');
            
            els.select.disabled = false;
            els.deckStack.classList.remove('hidden', 'shuffling');
            
            setStatus(!isLoggedIn ? "ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼ˆä¸¦ã¹æ–¹ï¼‰ã‚’é¸ã‚“ã§é–‹å§‹ã—ã¦ãã ã•ã„ã€‚" : (!currentTopic ? "ãƒ†ãƒ¼ãƒã‚’è¨­å®šã—ã¦å ã„ã‚’é–‹å§‹ã—ã¾ã™ã€‚" : "ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚"));
        }

        // --- Utility ---
        function updateTopicUI() {
            els.topicDisplay.className = currentTopic ? "text-center border-t border-gray-400 pt-1 mt-1 w-full max-w-md" : "hidden";
            if(currentTopic) els.topicText.innerText = currentTopic;
        }

        let dragItem = null, startX, startY, initL, initT;
        function handleDragStart(e) {
            if (currentState !== 'FINISHED') return;
            const target = e.target.closest('.card-scene');
            if (!target) return;
            const evt = e.type.includes('mouse') ? e : e.touches[0];
            dragItem = target;
            dragItem.style.zIndex = 100; dragItem.style.transition = 'none';
            initL = parseFloat(dragItem.style.left); initT = parseFloat(dragItem.style.top);
            startX = evt.clientX; startY = evt.clientY;
            if (e.type === 'touchstart') e.preventDefault();
        }
        function handleDragMove(e) {
            if (!dragItem) return;
            const evt = e.type.includes('mouse') ? e : e.touches[0];
            dragItem.style.left = `${initL + (evt.clientX - startX)}px`;
            dragItem.style.top = `${initT + (evt.clientY - startY)}px`;
            if(e.cancelable) e.preventDefault();
        }
        function handleDragEnd() { if(dragItem) { dragItem.style.zIndex = 50; dragItem = null; } }

        function showModal(el) { el.classList.add('active'); }
        function hideModal(el) { el.classList.remove('active'); }
        function showToast(msg, type='info') {
            const t = document.createElement('div');
            t.className = 'toast'; t.innerHTML = msg;
            if(type==='success') t.style.borderLeftColor = 'lightgreen';
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => { t.style.opacity=0; setTimeout(()=>t.remove(),300); }, 3000);
        }
        let typeInt;
        function setStatus(msg) {
            if(!els.guideBubble) return;
            els.guideBubble.classList.remove('bubble-pop'); void els.guideBubble.offsetWidth; els.guideBubble.classList.add('bubble-pop');
            els.guideText.textContent = ''; clearInterval(typeInt);
            let i=0; typeInt = setInterval(() => { els.guideText.textContent += msg.charAt(i++); if(i>=msg.length) clearInterval(typeInt); }, 50);
        }
        async function handleNativeShare() {
            const txt = `ğŸ”® The Daily Oracle\nTheme: ${currentTopic || 'My Destiny'}`;
            try { await navigator.share({ title: 'The Daily Oracle', text: txt, url: "https://tarot.design4qol.com/" }); }
            catch { navigator.clipboard.writeText(txt + " https://tarot.design4qol.com/"); showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
        }

        init();
    </script>
</body>
</html>
